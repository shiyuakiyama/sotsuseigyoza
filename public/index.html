<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UtsunomiYa Quick Guide - È§ÉÂ≠ê„Éª„Ç´„ÇØ„ÉÜ„É´„Éª„Ç∏„É£„Ç∫‰ΩìÈ®ì</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to left, #ffd89b 0%, #19547b 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }
        
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.5; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 15px 0;
            position: relative;
            flex-shrink: 0;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
        }
        
        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            margin-bottom: 8px;
            background: linear-gradient(45deg, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 3s ease-in-out infinite;
        }
        
        @keyframes titleShimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
            animation: fadeInUp 1s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 0.9; transform: translateY(0); }
        }
        
        .theme-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .theme-icon {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            animation: bounce 2s ease-in-out infinite;
        }
        
        .theme-icon:nth-child(2) { animation-delay: 0.2s; }
        .theme-icon:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .theme-icon:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 10px 30px rgba(255,255,255,0.2);
        }
        
        .map-container {
            flex: 1;
            position: relative;
            background: rgba(255,255,255,0.95);
            border-radius: 20px 20px 0 0;
            margin-top: 10px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .map-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        /* Leaflet„Éû„ÉÉ„Éó„ÅÆ„Çπ„Çø„Ç§„É´ */
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            touch-action: pan-x pan-y pinch-zoom; /* „Çø„ÉÉ„ÉÅÊìç‰Ωú„ÇíË®±ÂèØ */
        }
        /* „Ç´„Çπ„Çø„É†„Éû„Éº„Ç´„Éº„Ç¢„Ç§„Ç≥„É≥ */
        .custom-marker {
            width: 32px;
            height: 32px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .custom-marker:hover {
            transform: rotate(-45deg) scale(1.2);
        }

        .custom-marker::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .marker-emoji {
            transform: rotate(45deg);
            font-size: 16px;
        }

        .marker-gyoza { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .marker-cocktail { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .marker-jazz { background: linear-gradient(135deg, #f093fb, #f5576c); }
        
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 200;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .map-control-btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .filter-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 200;
        }
        
        .category-filter {
            display: flex;
            gap: 8px;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .category-filter-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0.6;
        }
        
        .category-filter-btn.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .category-filter-btn.gyoza { background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; }
        .category-filter-btn.cocktail { background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; }
        .category-filter-btn.jazz { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .category-filter-btn.all { background: linear-gradient(#19547b 100%); color: white; }
        
        .settings-panel {
            position: absolute;
            bottom: 80px;
            left: 15px;
            z-index: 300;
        }
        
        .settings-toggle {
            width: 50px;
            height: 50px;
            background: linear-gradient(#19547b 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .settings-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .settings-toggle.active {
            transform: rotate(45deg);
        }
        
        .settings-content {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            min-width: 280px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0);
            transform-origin: bottom left;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .settings-content.active {
            transform: scale(1);
            opacity: 1;
        }
        
        .settings-group {
            margin-bottom: 15px;
        }
        
        .settings-group:last-child {
            margin-bottom: 0;
        }
        
        .settings-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        .settings-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .settings-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .quick-action-btn {
            flex: 1;
            background: linear-gradient(to left, #ffd89b 0%, #19547b 100%);
            color: white;
            border: none;
            padding: 10px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUpModal 0.4s ease;
        }
        
        @keyframes slideUpModal {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px 20px 0 20px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .modal-body {
            padding: 0 20px 20px 20px;
        }
        
        .place-card-modal {
            background: white;
            position: relative;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .place-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .category-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .category-gyoza {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .category-cocktail {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .category-jazz {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-available {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .status-busy {
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: white;
        }
        
        .status-full {
            background: linear-gradient(135deg, #fc4a1a, #f7b733);
            color: white;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .info-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(5px);
        }
        
        .info-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(#19547b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .stars {
            color: #ffc107;
            font-size: 18px;
        }
        
        .realtime-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            position: relative;
        }
        
        .realtime-info::before {
            content: 'üî¥';
            position: absolute;
            top: 10px;
            right: 15px;
            animation: pulse 2s infinite;
        }
        
        .realtime-info h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .realtime-info p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        .social-feedback {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .social-feedback:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .social-feedback::before {
            content: 'üí¨';
            position: absolute;
            top: 10px;
            right: 15px;
        }
        
        .social-feedback::after {
            content: 'üëÜ „Çø„ÉÉ„Éó„ÅßÂè£„Ç≥„Éü‰∏ÄË¶ß';
            position: absolute;
            bottom: 5px;
            right: 15px;
            font-size: 10px;
            color: #888;
        }
        
        .social-feedback h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        .social-feedback p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            font-style: italic;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn-primary {
            flex: 1;
            background: linear-gradient(to left, #ffd89b 0%, #19547b 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            color: #4a5568;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            transform: translateY(-2px);
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .reviews-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .review-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }
        
        .review-item:hover {
            background: #f8f9fa;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .review-author {
            font-weight: 600;
            color: #333;
        }
        
        .review-date {
            font-size: 12px;
            color: #666;
        }
        
        .review-rating {
            color: #ffc107;
            margin-bottom: 5px;
        }
        
        .review-text {
            font-size: 14px;
            line-height: 1.5;
            color: #555;
            margin-bottom: 10px;
        }
        
        .review-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .helpful-button {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .helpful-button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .helpful-button.voted {
            background: #667eea;
            color: white;
            border-color: #667eea;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* „É´„Éº„ÉàÈÅ∏ÊäûÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .route-selection-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 90%;
            display: none;
        }

        .route-selection-panel.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .route-selection-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .selected-places {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .selected-place-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-place-tag button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .route-actions {
            display: flex;
            gap: 8px;
        }

        .route-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-route-btn {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .clear-route-btn {
            background: #e2e8f0;
            color: #4a5568;
        }

        .custom-marker-wrapper {
            background: transparent !important;
            border: none !important;
            pointer-events: auto !important;
            cursor: pointer !important;
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: rgba(255,215,0,0.3) !important;
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        .custom-marker-wrapper *,
        .custom-marker-wrapper .custom-marker,
        .custom-marker-wrapper .marker-emoji {
            pointer-events: auto !important;
            touch-action: manipulation !important;
            cursor: pointer !important;
        }

        .leaflet-routing-container {
            display: none;
        }
        
        /* Ê∑∑ÈõëÂ∫¶„Å´„Çà„ÇãËâ≤ÂàÜ„Åë */
        .marker-available { 
            background: linear-gradient(135deg, #56ab2f, #a8e6cf) !important; /* Á∑ëÔºöÁ©∫„Åç */
        }
        .marker-normal { 
            background: linear-gradient(135deg, #f7971e, #ffd200) !important; /* ÈªÑÔºöÊôÆÈÄö */
        }
        .marker-busy { 
            background: linear-gradient(135deg, #fc4a1a, #f7b733) !important; /* Ëµ§ÔºöÊ∑∑Èõë */
        }

        /* Ë∑ùÈõ¢Ë°®Á§∫ */
        .marker-distance {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            white-space: nowrap;
            pointer-events: none;
        }

        /* 2ÊÆµÈöéÁõÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        /* 2ÊÆµÈöéÁõÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó - „Çπ„Éû„ÉõÊúÄÈÅ©ÂåñÁâà */
        .quick-info-popup {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            top: 0 !important;
            background: rgba(0,0,0,0.5);
            z-index: 10000 !important;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }

        .quick-info-popup.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .quick-info-content {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
            position: relative;
            z-index: 10001 !important;
        }

        .quick-info-popup.active .quick-info-content {
            transform: translateY(0);
        }

        .quick-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quick-category {
            background: linear-gradient(#19547b 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .quick-close {
            background: #f0f0f0;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .quick-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .quick-status {
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .quick-time {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .quick-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;}

            .quick-stars {
                color: #ffc107;
            }

            .quick-menu {
                display: flex;
                gap: 12px;
                margin-bottom: 15px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 12px;
            }

            .menu-photo {
                width: 80px;
                height: 80px;
                border-radius: 8px;
                background-size: cover;
                background-position: center;
                background-color: #ddd;
                flex-shrink: 0;
            }

            .menu-text {
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 4px;
            }

            .menu-text strong {
                font-size: 14px;
                color: #333;
            }

            .menu-text span {
                font-size: 13px;
                color: #666;
            }

            .btn-detail {
                width: 100%;
                background: linear-gradient(to right, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 14px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btn-detail:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            /* 3ÊÆµÈöéÁõÆË©≥Á¥∞„Ç∑„Éº„ÉàÁî® */
            .detail-priority-info {
                background: #fff8e1;
                padding: 15px;
                border-radius: 12px;
                margin-bottom: 15px;
            }

            .priority-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                font-size: 14px;
            }

            .priority-item:last-child {
                margin-bottom: 0;
            }

            .detail-section {
                margin-bottom: 20px;
            }

            .detail-section h4 {
                font-size: 16px;
                margin-bottom: 10px;
                color: #333;
            }

            .menu-list {
                background: #f8f9fa;
                padding: 12px;
                border-radius: 10px;
            }

            .menu-item {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #e0e0e0;
            }

            .menu-item:last-child {
                border-bottom: none;
            }

            .menu-name {
                font-size: 14px;
                color: #333;
            }

            .menu-price {
                font-size: 14px;
                color: #667eea;
                font-weight: 600;
            }

            .reviews-mini {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .review-mini {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 8px;
            }

            .review-mini-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 13px;
            }

            .review-mini-rating {
                color: #ffc107;
            }

            .review-mini p {
                font-size: 13px;
                color: #666;
                margin: 0;
            }

            .detail-description {
                background: #e3f2fd;
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 15px;
            }

            .detail-description p {
                font-size: 14px;
                color: #555;
                line-height: 1.6;
                margin: 0;
            }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .theme-icons {
                gap: 15px;
                font-size: 1.3rem;
            }
            
            .settings-content {
                min-width: 260px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        *:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* AI„ÉÅ„É£„ÉÉ„Éà„É¢„Éº„ÉÄ„É´ */
        .ai-chat-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            top: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .ai-chat-container {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            height: 70vh;
            display: flex;
            flex-direction: column;
            animation: slideUpModal 0.4s ease;
        }

        .ai-chat-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .ai-chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-message,
        .user-message {
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 80%;
            animation: messageSlideIn 0.3s ease;
        }

        .ai-message {
            background: #f0f0f0;
            align-self: flex-start;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
        }

        .ai-chat-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .ai-option-btn {
            padding: 12px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-option-btn:hover {
            background: #667eea;
            color: white;
        }

        .ai-typing {
            display: flex;
            gap: 5px;
            padding: 10px;
        }

        .ai-typing span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .ai-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="bg-particles" id="particles"></div>

    <div class="container">
        <div class="header">
            <h1>„ÅÜ„Å§„ÅÆ„ÅøYEAHÔºÅ</h1>
            <p>"Â∏∞„ÇäÈÅì„ÅØÂÆáÈÉΩÂÆÆ„Åß„ÄÇ"</p>
            <p>"ÂØÑ„ÇäÈÅì„Åå„ÄÅÁâπÂà•„Å™ÊóÖ„Å´„Å™„Çã„ÄÇ"</p>
            <div class="theme-icons">
                <div class="theme-icon" tabindex="0" role="button" aria-label="È§ÉÂ≠ê„Çπ„Éù„ÉÉ„Éà">ü•ü</div>
                <div class="theme-icon" tabindex="0" role="button" aria-label="„Ç´„ÇØ„ÉÜ„É´„Éê„Éº">üç∏</div>
                <div class="theme-icon" tabindex="0" role="button" aria-label="„Ç∏„É£„Ç∫„ÇØ„É©„Éñ">üé∑</div>
            </div>
        </div>
        
        <div class="map-container">
            <div class="map-wrapper">
                <div class="filter-toggle">
                    <div class="category-filter">
                        <button class="category-filter-btn all active" data-category="all" aria-label="ÂÖ®„Ç´„ÉÜ„Ç¥„É™">üåü</button>
                        <button class="category-filter-btn gyoza" data-category="gyoza" aria-label="È§ÉÂ≠ê">ü•ü</button>
                        <button class="category-filter-btn cocktail" data-category="cocktail" aria-label="„Ç´„ÇØ„ÉÜ„É´">üç∏</button>
                        <button class="category-filter-btn jazz" data-category="jazz" aria-label="„Ç∏„É£„Ç∫">üé∑</button>
                    </div>
                </div>
                
                <div class="map-controls">
                    <button class="map-control-btn" onclick="zoomIn()" aria-label="Êã°Â§ß">+</button>
                    <button class="map-control-btn" onclick="zoomOut()" aria-label="Á∏ÆÂ∞è">-</button>
                    <button class="map-control-btn" onclick="resetView()" aria-label="Ë°®Á§∫„É™„Çª„ÉÉ„Éà">‚åÇ</button>
                    <button class="map-control-btn" onclick="toggleRouteMode()" aria-label="„É´„Éº„Éà‰ΩúÊàê„É¢„Éº„Éâ" title="„É´„Éº„Éà‰ΩúÊàê">üó∫Ô∏è</button>
                    <button class="map-control-btn" onclick="openAIChat()" aria-label="AIÊ°àÂÜÖ" title="AIÊ°àÂÜÖ" 
                            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                        ü§ñ
                    </button>
                </div>
                
                <!-- Leaflet „Éû„ÉÉ„Éó -->
                <div id="map"></div>
                <!-- „É´„Éº„ÉàÈÅ∏Êäû„Éë„Éç„É´ -->
                <div class="route-selection-panel" id="routePanel">
                    <div class="route-selection-header">üìç Ë®™Âïè„Åô„ÇãÂ†¥ÊâÄ„ÇíÈÅ∏Êäû</div>
                    <div class="selected-places" id="selectedPlaces"></div>
                    <div class="route-actions">
                        <button class="create-route-btn" onclick="createOptimalRoute()">„É´„Éº„Éà„Çí‰ΩúÊàê</button>
                        <button class="clear-route-btn" onclick="clearRouteSelection()">„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel">
                <div class="settings-content" id="settingsContent">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;">‚öôÔ∏è Ë®≠ÂÆö„ÉªÁÆ°ÁêÜ</h3>
                    <!-- ‚òÖ „Éû„ÉÉ„Éó„Çπ„Çø„Ç§„É´Â§âÊõ¥(Êñ∞Ê©üËÉΩ) -->
                    <div class="settings-group">
                        <label>üó∫Ô∏è „Éû„ÉÉ„Éó„Çπ„Çø„Ç§„É´</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <button type="button" onclick="changeMapStyle('standard')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: white; color: #333; font-weight: 600; cursor: pointer; font-size: 12px;
                                transition: all 0.3s ease;
                            ">üåç Ê®ôÊ∫ñ</button>
            
                            <button type="button" onclick="changeMapStyle('dark')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: #2c3e50; color: white; font-weight: 600; cursor: pointer; font-size: 12px;
                                transition: all 0.3s ease;
                            ">üåô „ÉÄ„Éº„ÇØ</button>
            
                            <button type="button" onclick="changeMapStyle('watercolor')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; 
                                font-weight: 600; cursor: pointer; font-size: 12px;
                                transition: all 0.3s ease;
                            ">üé® Ê∞¥ÂΩ©</button>
            
                            <button type="button" onclick="changeMapStyle('satellite')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: linear-gradient(135deg, #4a90e2, #50c878); color: white; 
                                font-weight: 600; cursor: pointer; font-size: 12px;
                                transition: all 0.3s ease;
                            ">üõ∞Ô∏è Âú∞ÂΩ¢</button>
                        </div>
                        <small style="display: block; margin-top: 8px; color: #666;">
                        </small>
                    </div>
    
                    <!-- ‚òÖ ËÉåÊôØ„ÉÜ„Éº„ÉûÂ§âÊõ¥ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ -->
                    <div class="settings-group">
                        <label>üé® ËÉåÊôØ„ÉÜ„Éº„Éû</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <button type="button" onclick="changeThemeColor('ocean')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: linear-gradient(to left, #ffd89b 0%, #19547b 100%);
                                color: white; font-weight: 600; cursor: pointer; font-size: 12px;
                            ">„Ç™„Éº„Ç∑„É£„É≥</button>
            
                            <button type="button" onclick="changeThemeColor('sunset')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: linear-gradient(to left, #7084a5, #ada6be, #d4b0b5);
                                color: white; font-weight: 600; cursor: pointer; font-size: 12px;
                            ">„Çµ„É≥„Çª„ÉÉ„Éà</button>
            
                            <button type="button" onclick="changeThemeColor('forest')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: linear-gradient(to left, #2f7f29, #549854, #a5caa7);
                                color: white; font-weight: 600; cursor: pointer; font-size: 12px;
                            ">„Éï„Ç©„É¨„Çπ„Éà</button>
            
                            <button type="button" onclick="changeThemeColor('night')" style="
                                padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
                                background: linear-gradient(135deg, #5c658b, #1c2c52, #051637);
                                color: white; font-weight: 600; cursor: pointer; font-size: 12px;
                            ">„Éä„Ç§„Éà</button>
                        </div>
                        <small style="display: block; margin-top: 8px; color: #666;">
                        </small>
                    </div>
    
                    <button type="button" onclick="resetThemeColor()" style="
                        width: 100%; padding: 10px; background: #e2e8f0; 
                        color: #4a5568; border: none; border-radius: 8px; 
                        font-weight: 600; cursor: pointer; margin-top: 10px; 
                        transition: all 0.3s ease; font-size: 13px;
                    ">
                        üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô
                    </button>
                </div>
                
                <button class="settings-toggle" id="settingsToggle" onclick="toggleSettings()" aria-label="Ë®≠ÂÆö„Éë„Éç„É´„ÇíÈñã„Åè">‚öôÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>

    <script>
        // ============================================
        // Ë®≠ÂÆö„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
        // ============================================
        let appConfig = null;

        async function loadAppConfig() {
            try {
                const response = await fetch(`${API_URL}/config`);
                appConfig = await response.json();
                console.log('‚úÖ Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', appConfig);
        
                // „Çø„Ç§„Éà„É´„Å®„Çµ„Éñ„Çø„Ç§„Éà„É´„ÇíÂèçÊò†
                document.querySelector('.header h1').textContent = appConfig.appTitle;
                const subtitles = document.querySelectorAll('.header p');
                if (subtitles[0]) subtitles[0].textContent = appConfig.subtitle1;
                if (subtitles[1]) subtitles[1].textContent = appConfig.subtitle2;
        
                // „ÉÜ„Éº„Éû„Ç¢„Ç§„Ç≥„É≥„ÇíÂãïÁöÑÁîüÊàê
                initializeThemeIcons();
        
                return appConfig;
            } catch (error) {
                console.error('‚ùå Ë®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                appConfig = {
                    appTitle: "„ÅÜ„Å§„ÅÆ„ÅøYEAH!",
                    subtitle1: "Â∏∞„ÇäÈÅì„ÅØÂÆáÈÉΩÂÆÆ„Åß„ÄÇ",
                    subtitle2: "ÂØÑ„ÇäÈÅì„Åå„ÄÅÁâπÂà•„Å™ÊóÖ„Å´„Å™„Çã„ÄÇ",
                    map: {
                        center: { lat: 36.5579, lng: 139.8984 },
                        zoom: 14
                    },
                    categories: [
                        { id: 'gyoza', name: 'È§ÉÂ≠ê', emoji: 'ü•ü' },
                        { id: 'cocktail', name: '„Ç´„ÇØ„ÉÜ„É´', emoji: 'üç∏' },
                        { id: 'jazz', name: '„Ç∏„É£„Ç∫', emoji: 'üé∑' }
                    ],
                    ai: {
                        greeting: '„Åì„Çì„Å´„Å°„ÅØ!ÂÆáÈÉΩÂÆÆË¶≥ÂÖâAIÊ°àÂÜÖ„Åß„Åô üéâ',
                        description: 'Áü≠ÊôÇÈñì„ÅßÂÆáÈÉΩÂÆÆ„ÇíÊ•Ω„Åó„ÇÄÊúÄÈÅ©„Å™„É´„Éº„Éà„Çí„ÅîÊèêÊ°à„Åó„Åæ„Åô!',
                        categoryPrompt: '‰Ωï„Çí‰ΩìÈ®ì„Åó„Åü„ÅÑ„Åß„Åô„Åã?'
                    }
                };
                return appConfig;
            }
        }

        // „ÉÜ„Éº„Éû„Ç¢„Ç§„Ç≥„É≥„ÇíÂãïÁöÑÁîüÊàê
        function initializeThemeIcons() {
            const container = document.querySelector('.theme-icons');
            if (container && appConfig && appConfig.categories) {
                container.innerHTML = appConfig.categories.map(cat => 
                    `<div class="theme-icon" tabindex="0" role="button" aria-label="${cat.name}„Çπ„Éù„ÉÉ„Éà">${cat.emoji}</div>`
                ).join('');
            }
        }

        // „Ç´„ÉÜ„Ç¥„É™„Éº„Éï„Ç£„É´„Çø„Éº„ÇíÂãïÁöÑÁîüÊàê
        function initializeCategoryFilter() {
            const filterContainer = document.querySelector('.category-filter');
            if (filterContainer && appConfig && appConfig.categories) {
                let html = '<button class="category-filter-btn all active" data-category="all" aria-label="ÂÖ®„Ç´„ÉÜ„Ç¥„É™">üåü</button>';
        
                appConfig.categories.forEach(cat => {
                    html += `<button class="category-filter-btn ${cat.id}" data-category="${cat.id}" aria-label="${cat.name}">${cat.emoji}</button>`;
                });
        
                filterContainer.innerHTML = html;
            }
        }

        // APIË®≠ÂÆö - „Çπ„Éû„ÉõÂØæÂøú
        const API_URL = (() => {
            const hostname = window.location.hostname;
            // localhost „Åæ„Åü„ÅØ 127.0.0.1 „ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„Åæ
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8000/api';
            }
            // „Åù„Çå‰ª•Â§ñ(IP„Ç¢„Éâ„É¨„Çπ)„ÅÆÂ†¥Âêà„ÅØÂêå„Åò„Éõ„Çπ„Éà„Çí‰ΩøÁî®
            return `http://${hostname}:8000/api`;
        })();
        
        // Â∫óËàó„Éá„Éº„Çø
        const samplePlaces = {
            gyoza: [
                {
                    id: 'gyoza_1',
                    name: "„Åø„Çì„Åø„Çì Êú¨Â∫ó",
                    category: "gyoza",
                    status: "available",
                    statusText: "Á©∫Â∏≠„ÅÇ„Çä",
                    distance: "850m",
                    walkTime: "11ÂàÜ",
                    waitTime: "5-10ÂàÜ",
                    rating: 4.3,
                    reviews: 1250,
                    priceRange: "¬•500-800",
                    specialty: "ÁÑºÈ§ÉÂ≠êÂÆöÈ£ü",
                    realtimeInfo: "ÁèæÂú®„ÅÆÊ∑∑ÈõëÂ∫¶: 60% | „ÉÜ„Éº„Éñ„É´Â∏≠Á©∫„Åç„ÅÇ„Çä | Âπ≥ÂùáÊªûÂú®ÊôÇÈñì: 45ÂàÜ",
                    tags: ["ËÄÅËàó", "ÈßêËªäÂ†¥Êúâ", "Âá∫ÂºµËÄÖ‰∫∫Ê∞ó"],
                    timeRecommendation: "30-60ÂàÜ",
                    lat: 36.5579,  // ‚Üê ËøΩÂä†
                    lng: 139.8984, // ‚Üê ËøΩÂä†
                    address: "Ê†ÉÊú®ÁúåÂÆáÈÉΩÂÆÆÂ∏Ç" // ‚Üê ËøΩÂä†
                },
                {
                    id: 'gyoza_2',
                    name: "Êù•„Çâ„Å£„Åõ",
                    category: "gyoza",
                    status: "busy",
                    statusText: "‰∫∫Ê∞ó„Çπ„Éù„ÉÉ„Éà",
                    distance: "1200m",
                    walkTime: "15ÂàÜ",
                    waitTime: "10-15ÂàÜ",
                    rating: 4.6,
                    reviews: 3200,
                    priceRange: "¬•300-500",
                    specialty: "È§ÉÂ≠êÈ£ü„ÅπÊØî„Åπ",
                    realtimeInfo: "Ë§áÊï∞Â∫óËàó„ÅÆÈ§ÉÂ≠ê„Çí‰∏ÄÂ∫¶„Å´Ê•Ω„Åó„ÇÅ„ÇãÈ§ÉÂ≠ê„ÉÜ„Éº„Éû„Éë„Éº„ÇØ | ÁèæÂú®7Â∫óËàóÂñ∂Ê•≠‰∏≠",
                    tags: ["Ë¶≥ÂÖâ„Çπ„Éù„ÉÉ„Éà", "È£ü„ÅπÊØî„Åπ", "ÂúüÁî£Ë≥ºÂÖ•ÂèØ"],
                    timeRecommendation: "60-90ÂàÜ",
                    lat: 36.5600, // ‚Üê ËøΩÂä†
                    lng: 139.8950, // ‚Üê ËøΩÂä†
                    address: "Ê†ÉÊú®ÁúåÂÆáÈÉΩÂÆÆÂ∏Ç" // ‚Üê ËøΩÂä†
                }
            ],
            cocktail: [
                {
                    id: 'cocktail_1',
                    name: "Â§¢ÈÖíOGAWA",
                    category: "cocktail",
                    status: "available",
                    statusText: "Âñ∂Ê•≠‰∏≠",
                    distance: "900m",
                    walkTime: "12ÂàÜ",
                    waitTime: "„Åô„ÅêÂÖ•Â∫óÂèØ",
                    rating: 4.5,
                    reviews: 890,
                    priceRange: "¬•800-1500",
                    specialty: "ÂÆáÈÉΩÂÆÆ„Ç´„ÇØ„ÉÜ„É´",
                    realtimeInfo: "Êú¨Êó•„ÅÆ„É©„Ç§„Éñ: 19:30„Äú | „Ç´„Ç¶„É≥„Çø„ÉºÂ∏≠Á©∫„Åç„ÅÇ„Çä | Âú∞ÂÖÉÈ£üÊùê‰ΩøÁî®„ÅÆ„Ç™„É™„Ç∏„Éä„É´„Ç´„ÇØ„ÉÜ„É´",
                    tags: ["„Ç∏„É£„Ç∫„É©„Ç§„Éñ", "Â§ß‰∫∫„ÅÆÁ©∫Èñì", "Âú∞ÈÖí„Ç´„ÇØ„ÉÜ„É´"],
                    timeRecommendation: "60-120ÂàÜ",
                    lat: 36.5590, // ‚Üê ËøΩÂä†
                    lng: 139.9000, // ‚Üê ËøΩÂä†
                    address: "Ê†ÉÊú®ÁúåÂÆáÈÉΩÂÆÆÂ∏Ç" // ‚Üê ËøΩÂä†
                },
                {
                    id: 'cocktail_2',
                    name: "SUKATTO",
                    category: "cocktail",
                    status: "available",
                    statusText: "Èõ∞Âõ≤Ê∞ó‚óé",
                    distance: "650m",
                    walkTime: "8ÂàÜ",
                    waitTime: "‰∫àÁ¥ÑÊé®Â•®",
                    rating: 4.2,
                    reviews: 567,
                    priceRange: "¬•1000-2000",
                    specialty: "Èö†„ÇåÂÆ∂„Ç´„ÇØ„ÉÜ„É´",
                    realtimeInfo: "„Ç´„ÇØ„ÉÜ„É´„ÅÆÁ®ÆÈ°û„ÇÇË±äÂØå„Åß„ÄÅ„Éê„Éº„ÉÜ„É≥„ÉÄ„Éº„ÅÆÊñπ„Åå‰∏Ä„Å§‰∏Ä„Å§Êâã‰Ωú„Çä | 18:00„ÄúÂñ∂Ê•≠",
                    tags: ["Èö†„ÇåÂÆ∂", "Êâã‰Ωú„Çä„Ç´„ÇØ„ÉÜ„É´", "„Ç¢„ÉÉ„Éà„Éõ„Éº„É†"],
                    timeRecommendation: "90-150ÂàÜ",
                    lat: 36.5565, // ‚Üê ËøΩÂä†
                    lng: 139.8970, // ‚Üê ËøΩÂä†
                    address: "Ê†ÉÊú®ÁúåÂÆáÈÉΩÂÆÆÂ∏Ç" // ‚Üê ËøΩÂä†
                }
            ],
            jazz: [
                {
                    id: 'jazz_1',
                    name: "KINDAIJIN",
                    category: "jazz",
                    status: "busy",
                    statusText: "ËÅñÂú∞",
                    distance: "900m",
                    walkTime: "12ÂàÜ",
                    waitTime: "19:00„ÄúÂñ∂Ê•≠",
                    rating: 4.8,
                    reviews: 850,
                    priceRange: "¬•2000-3500",
                    specialty: "ÂÆáÈÉΩÂÆÆ„Ç∏„É£„Ç∫„ÅÆËÅñÂú∞",
                    realtimeInfo: "1960Âπ¥ÂâµÊ•≠„ÅÆËÄÅËàó | ÂÆáÈÉΩÂÆÆ„Ç∏„É£„Ç∫„Ç∑„Éº„É≥„ÅÆÊ≠¥Âè≤„Åù„ÅÆ„ÇÇ„ÅÆ | Êú¨Êó•„ÅÆ„Çª„ÉÉ„Éà: 19:30/21:00",
                    tags: ["ËÄÅËàó1960Âπ¥„Äú", "„Ç∏„É£„Ç∫„ÅÆËÅñÂú∞", "Ê≠¥Âè≤ÁöÑ‰æ°ÂÄ§"],
                    timeRecommendation: "120-180ÂàÜ",
                    lat: 36.5610, // ‚Üê ËøΩÂä†
                    lng: 139.8965, // ‚Üê ËøΩÂä†
                    address: "Ê†ÉÊú®ÁúåÂÆáÈÉΩÂÆÆÂ∏Ç" // ‚Üê ËøΩÂä†
                }
            ]
        };
        
        let map; // ËøΩÂä†
        let markers = []; // ËøΩÂä†
        let currentFilter = 'all';
        let currentModal = null;
        let votedReviews = {};
        let routeControl = null; // ËøΩÂä†
        let isRouteMode = false; // ËøΩÂä†
        let selectedPlacesForRoute = []; // ËøΩÂä†
        let placesData = []; // ‚òÖ ËøΩÂä†
        let userLocation = null; // ‚òÖ ËøΩÂä†
        
        // Êó¢Â≠ò„ÅÆDOMContentLoadedÈÉ®ÂàÜ„Çí‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´‰øÆÊ≠£
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAppConfig(); // ‚Üê ÊúÄÂàù„Å´Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
            createParticles();
            initializeCategoryFilter(); // ‚Üê „Ç´„ÉÜ„Ç¥„É™„Éº„Éï„Ç£„É´„Çø„ÉºÁîüÊàê
            initializeMap();
            initializeFilters();
            getUserLocation();
        });



        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('ÁèæÂú®Âú∞ÂèñÂæóÊàêÂäü:', userLocation);
                        loadPlaces(); // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                    },
                    (error) => {
                        console.warn('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÂ§±Êïó:', error);
                        // „Éá„Éï„Ç©„É´„Éà„ÅßÂÆáÈÉΩÂÆÆÈßÖ„Çí‰ΩøÁî®
                        userLocation = { lat: 36.5579, lng: 139.8984 };
                        loadPlaces();
                    }
                );
            } else {
                console.warn('Geolocation„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                userLocation = { lat: 36.5579, lng: 139.8984 };
                loadPlaces();
            }
        }

        // „Çµ„Éº„Éê„Éº„Åã„ÇâÂ∫óËàó„Éá„Éº„Çø„ÇíÂèñÂæó
        async function loadPlaces() {
            try {
                let url = `${API_URL}/places?category=${currentFilter}`;
                
                if (userLocation) {
                    url += `&lat=${userLocation.lat}&lng=${userLocation.lng}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch places');
                }
                
                placesData = await response.json();
                
                // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                // Êñ∞„Åó„ÅÑ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
                placesData.forEach(place => {
                    if (place.lat && place.lng) {
                        createMarker(place);
                    }
                });
                
                console.log(`${placesData.length}‰ª∂„ÅÆÂ∫óËàó„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);

                setTimeout(() => {
                    console.log('üìç „Éû„Éº„Ç´„ÉºÊï∞:', markers.length);
                    markers.forEach((marker, index) => {
                        const element = marker.getElement();
                        console.log(`„Éû„Éº„Ç´„Éº${index}:`, element ? 'Ë¶ÅÁ¥†„ÅÇ„Çä' : 'Ë¶ÅÁ¥†„Å™„Åó', marker.placeData.name);
                    });
                }, 3000);
                
            } catch (error) {
                console.error('Â∫óËàó„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                console.log('„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô');
                
                // „Çµ„Éº„Éê„Éº„ÅåÂãï„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÊó¢Â≠ò„ÅÆsamplePlaces„Çí‰ΩøÁî®
                const fallbackPlaces = [];
                Object.values(samplePlaces).forEach(categoryPlaces => {
                    fallbackPlaces.push(...categoryPlaces);
                });
                
                fallbackPlaces.forEach(place => {
                    if (place.lat && place.lng) {
                        createMarker(place);
                    }
                });
                
                showToast('‚ö†Ô∏è „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„ÇìÔºà„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„ÉâÔºâ');
            }
        }
        
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = Math.random() * 4 + 2 + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }
        
        // Êó¢Â≠ò„ÅÆinitializeMap()Èñ¢Êï∞„Çí‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´‰øÆÊ≠£
        function initializeMap() {
            const center = appConfig ? 
                [appConfig.map.center.lat, appConfig.map.center.lng] :
                [36.5579, 139.8984];
            const zoom = appConfig ? appConfig.map.zoom : 14;
    
            map = L.map('map', {
                center: center,
                zoom: zoom,
                zoomControl: false,
                tap: true,
                tapTolerance: 50,
                touchZoom: true,
                dragging: true,
                boxZoom: false,
                doubleClickZoom: true,
                keyboard: false,
                scrollWheelZoom: true,
                preferCanvas: false,
                trackResize: true,
                tapHold: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            map.whenReady(function() {
                console.log('üó∫Ô∏è „Éû„ÉÉ„ÉóÊ∫ñÂÇôÂÆå‰∫Ü');
            });
        }
        // „Ç´„Çπ„Çø„É†„Éû„Éº„Ç´„Éº„Çí‰ΩúÊàê
        function createMarker(place) {
            const emoji = place.category === 'gyoza' ? 'ü•ü' : 
                        place.category === 'cocktail' ? 'üç∏' : 'üé∑';

            const statusClass = place.status === 'available' ? 'marker-available' :
                            place.status === 'busy' ? 'marker-busy' : 'marker-normal';
    
            const distanceHtml = place.distance ? 
                `<span class="marker-distance">${place.distance}</span>` : '';

            const iconHtml = `
                <div class="custom-marker ${statusClass}">
                    <span class="marker-emoji">${emoji}</span>
                    ${distanceHtml}
                </div>
            `;

            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'custom-marker-wrapper',
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });

            const marker = L.marker([place.lat, place.lng], { 
                icon: customIcon,
                interactive: true,
                bubblingMouseEvents: false,
                keyboard: false
            }).addTo(map);

            // ‚òÖ ÈáçË¶Å: „Éû„Éº„Ç´„Éº„ÅåÂú∞Âõ≥„Å´ËøΩÂä†„Åï„Çå„ÅüÁõ¥Âæå„Å´„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
            setTimeout(() => {
                const markerElement = marker.getElement();
                if (markerElement) {
                    // „Çπ„Çø„Ç§„É´Ë®≠ÂÆö
                    markerElement.style.pointerEvents = 'auto';
                    markerElement.style.cursor = 'pointer';
                    markerElement.style.touchAction = 'manipulation';
                    markerElement.style.zIndex = '1000';
            
                    // „Çø„ÉÉ„Éó„Éè„É≥„Éâ„É©
                    const handleClick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
    
                        if (isRouteMode) {
                            togglePlaceSelection(place);
                        } else {
                            closeQuickInfo();
                            setTimeout(() => {
                                showQuickInfo(place);
                            }, 350);
                        }
                    };
            
                    // ÂÖ®„Å¶„ÅÆ„Ç§„Éô„É≥„Éà„Çø„Ç§„Éó„Å´ÂØæÂøú
                    markerElement.addEventListener('touchstart', handleClick, { passive: false });
                    markerElement.addEventListener('touchend', handleClick, { passive: false });
                    markerElement.addEventListener('click', handleClick);
            
                    // Â≠êË¶ÅÁ¥†„Å´„ÇÇ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
                    const markerIcon = markerElement.querySelector('.custom-marker');
                    if (markerIcon) {
                        markerIcon.addEventListener('touchstart', handleClick, { passive: false });
                        markerIcon.addEventListener('touchend', handleClick, { passive: false });
                        markerIcon.addEventListener('click', handleClick);
                    }
            
                    console.log('‚úÖ „Éû„Éº„Ç´„Éº„Ç§„Éô„É≥„ÉàË®≠ÂÆöÂÆå‰∫Ü:', place.name);
                } else {
                    console.error('‚ùå „Éû„Éº„Ç´„ÉºË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', place.name);
                }
            }, 100); // 100msÂæÖ„Å£„Å¶„Åã„Çâ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö

            marker.placeData = place;
            markers.push(marker);
        }
        
        // ‚òÖ‚òÖ‚òÖ „Åì„Åì„Åã„ÇâËøΩÂä† ‚òÖ‚òÖ‚òÖ
        
        // „Éï„Ç£„É´„Çø„ÉºÂàùÊúüÂåñÔºà‰∏äÊõ∏„ÅçÔºâ
        function initializeFilters() {
            const filterButtons = document.querySelectorAll('.category-filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    currentFilter = button.dataset.category;
                    
                    // „Çµ„Éº„Éê„Éº„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞ÂÜçÂèñÂæó
                    if (placesData.length > 0) {
                        loadPlaces();
                    } else {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅØ„Éû„Éº„Ç´„ÉºË°®Á§∫„ÅÆ„ÅøÊõ¥Êñ∞
                        updateMarkerVisibility();
                    }
                });
            });
        }
        
        // ‚òÖ‚òÖ‚òÖ „Åì„Åì„Åæ„ÅßËøΩÂä† ‚òÖ‚òÖ‚òÖ    
        function toggleSettings() {
            const content = document.getElementById('settingsContent');
            const toggle = document.getElementById('settingsToggle');
            
            content.classList.toggle('active');
            toggle.classList.toggle('active');
            
            const isOpen = content.classList.contains('active');
            toggle.setAttribute('aria-label', isOpen ? 'Ë®≠ÂÆö„Éë„Éç„É´„ÇíÈñâ„Åò„Çã' : 'Ë®≠ÂÆö„Éë„Éç„É´„ÇíÈñã„Åè');
        }
        
        function showQuickInfo(place) {
            console.log('üü° showQuickInfoÂëº„Å≥Âá∫„Åó:', place.name); // „Éá„Éê„ÉÉ„Ç∞Áî®
    
            // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂÆåÂÖ®ÂâäÈô§
            closeQuickInfo();
    
            const popup = document.createElement('div');
            popup.className = 'quick-info-popup';
            popup.id = 'quickInfoPopup';
            popup.style.zIndex = '10000'; // Á¢∫ÂÆü„Å´ÊúÄÂâçÈù¢„Å´
    
            const categoryNames = { gyoza: 'È§ÉÂ≠ê', cocktail: '„Ç´„ÇØ„ÉÜ„É´', jazz: '„Ç∏„É£„Ç∫' };
            const statusText = {
                available: 'üü¢ Á©∫Â∏≠„ÅÇ„Çä',
                normal: 'üü° ÊôÆÈÄö',
                busy: 'üî¥ Ê∑∑Èõë‰∏≠'
            };
    
            popup.innerHTML = `
                <div class="quick-info-content">
                    <div class="quick-info-header">
                        <span class="quick-category">${categoryNames[place.category]}</span>
                        <button class="quick-close" onclick="closeQuickInfo()">√ó</button>
                    </div>
            
                    <h3 class="quick-name">${place.name}</h3>
            
                    <div class="quick-status">${statusText[place.status]}</div>
            
                    <div class="quick-time">
                        ‚è±Ô∏è ÊªûÂú®ÁõÆÂÆâ: <strong>${place.stay_time || place.timeRecommendation}</strong>
                    </div>
            
                    <div class="quick-rating">
                        <span class="quick-stars">${'‚òÖ'.repeat(Math.floor(place.rating))}${'‚òÜ'.repeat(5 - Math.floor(place.rating))}</span>
                        <span>${place.rating} (${place.review_count || place.reviews}‰ª∂)</span>
                    </div>
            
                    <div class="quick-menu">
                        <div class="menu-photo" style="background-image: url('${place.menu_photo || place.menuPhoto || ''}')"></div>
                        <div class="menu-text">
                            <strong>${place.specialty}</strong>
                            <span>${place.price_range || place.priceRange}</span>
                        </div>
                    </div>
            
                    <button class="btn-detail" onclick="showDetailSheet('${place.id}')">
                        Ë©≥„Åó„ÅèË¶ã„Çã ‚Üí
                    </button>
                </div>
            `;
    
            document.body.appendChild(popup);
            console.log('üü£ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóDOMËøΩÂä†ÂÆå‰∫Ü'); // „Éá„Éê„ÉÉ„Ç∞Áî®
    
            // Âº∑Âà∂ÂÜçÊèèÁîª
            void popup.offsetHeight;
    
            // active„ÇØ„É©„ÇπËøΩÂä†
            requestAnimationFrame(() => {
                popup.classList.add('active');
                console.log('üîµ active„ÇØ„É©„ÇπËøΩÂä†ÂÆå‰∫Ü'); // „Éá„Éê„ÉÉ„Ç∞Áî®
            });
    
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºàÁ∞°Áï•ÂåñÁâàÔºâ
            popup.addEventListener('click', (e) => {
                if (e.target === popup || e.target.classList.contains('quick-close')) {
                    closeQuickInfo();
                }
            }, true); // „Ç≠„É£„Éó„ÉÅ„É£„Éï„Çß„Éº„Ç∫„ÅßÂá¶ÁêÜ
    
            const quickContent = popup.querySelector('.quick-info-content');
            if (quickContent) {
                quickContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        function closeQuickInfo() {
            console.log('üî¥ closeQuickInfoÂëº„Å≥Âá∫„Åó'); // „Éá„Éê„ÉÉ„Ç∞Áî®
            const popup = document.getElementById('quickInfoPopup');
            if (popup) {
                popup.classList.remove('active');
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.remove();
                        console.log('üóëÔ∏è „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂâäÈô§ÂÆå‰∫Ü'); // „Éá„Éê„ÉÉ„Ç∞Áî®
                    }
                }, 300);
            }
        }

        // 3ÊÆµÈöéÁõÆ„ÅÆË©≥Á¥∞„Ç∑„Éº„ÉàË°®Á§∫
        // index.html„ÅÆshowDetailModalÈñ¢Êï∞„Çí‰ª•‰∏ã„Å´ÁΩÆ„ÅçÊèõ„Åà

        async function showDetailSheet(placeId) {
            closeQuickInfo();
    
            try {
                // Â∫óËàóÊÉÖÂ†±„ÇíÂèñÂæó
                const response = await fetch(`${API_URL}/places/${placeId}`);
                if (!response.ok) throw new Error('Failed to fetch place details');
        
                const place = await response.json();
        
                // SNSÊäïÁ®ø„ÇíÂèñÂæó
                let socialPostsHTML = '';
                try {
                    const socialResponse = await fetch(`${API_URL}/store/${placeId}/social-posts`);
                    if (socialResponse.ok) {
                        const socialData = await socialResponse.json();
                        socialPostsHTML = generateSocialPostsHTML(socialData);
                    }
                } catch (error) {
                    console.log('SNSÊäïÁ®øÂèñÂæó„Çπ„Ç≠„ÉÉ„Éó:', error);
                }
        
                // Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫ÔºàSNSÊäïÁ®ø„ÇíÂê´„ÇÄÔºâ
                showDetailModalWithSocial(place, socialPostsHTML);
        
            } catch (error) {
                console.error('Ë©≥Á¥∞ÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error);
        
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                let foundPlace = null;
                Object.values(samplePlaces).forEach(categoryPlaces => {
                    categoryPlaces.forEach(p => {
                        if (p.id === placeId) foundPlace = p;
                    });
                });
        
                if (foundPlace) {
                    showPlaceModal(foundPlace);
                } else {
                    showToast('‚ö†Ô∏è Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
        }

        // SNSÊäïÁ®ø„ÅÆHTMLÁîüÊàê
        function generateSocialPostsHTML(socialData) {
            if (!socialData.posts) return '';
    
            let html = '<div class="social-posts-section">';
    
            // TwitterÊäïÁ®ø
            if (socialData.has_twitter && socialData.posts.twitter.length > 0) {
                html += `
                    <div class="social-section">
                        <h4 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="width: 30px; height: 30px; background: #1DA1F2; color: white; 
                                         border-radius: 50%; display: flex; align-items: center; 
                                         justify-content: center; font-size: 14px;">ùïè</span>
                            ÊúÄÊñ∞„ÅÆ„ÉÑ„Ç§„Éº„Éà
                        </h4>
                        <div class="social-posts-list">
                `;
        
                socialData.posts.twitter.forEach(tweet => {
                    const timeAgo = getTimeAgo(tweet.created_at);
                    html += `
                        <div class="social-post-item">
                            <div class="post-header">
                                <span style="font-weight: 600; color: #1DA1F2;">${tweet.author}</span>
                                <span style="font-size: 12px; color: #999;">${timeAgo}</span>
                            </div>
                            <div class="post-text">${escapeHtml(tweet.text)}</div>
                            <div class="post-stats">
                                <span>‚ù§Ô∏è ${tweet.likes}</span>
                                <span>üîÑ ${tweet.retweets}</span>
                            </div>
                        </div>
                    `;
                });
        
                html += `</div></div>`;
            }
    
            // InstagramÊäïÁ®ø
            if (socialData.has_instagram && socialData.posts.instagram.length > 0) {
                html += `
                    <div class="social-section" style="margin-top: 20px;">
                        <h4 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="width: 30px; height: 30px; 
                                         background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); 
                                         color: white; border-radius: 50%; display: flex; align-items: center; 
                                         justify-content: center; font-size: 14px;">üì∑</span>
                            ÊúÄÊñ∞„ÅÆÊäïÁ®ø
                        </h4>
                        <div class="social-posts-list">
                `;
        
                socialData.posts.instagram.forEach(post => {
                    const timeAgo = getTimeAgo(post.timestamp);
                    html += `
                        <div class="social-post-item">
                            <div class="post-header">
                                <span style="font-weight: 600; color: #E4405F;">@${post.username}</span>
                                <span style="font-size: 12px; color: #999;">${timeAgo}</span>
                            </div>
                            ${post.media_url ? `<img src="${post.media_url}" style="width: 100%; border-radius: 10px; margin: 10px 0;" alt="InstagramÊäïÁ®ø">` : ''}
                            <div class="post-text">${escapeHtml(post.caption)}</div>
                            <div class="post-stats">
                                <span>‚ù§Ô∏è ${post.likes}</span>
                            </div>
                        </div>
                    `;
                });
        
                html += `</div></div>`;
            }
    
            html += '</div>';
    
            // SNSÊäïÁ®ø„Åå„Å™„ÅÑÂ†¥Âêà
            if (!socialData.has_twitter && !socialData.has_instagram) {
                return '';
            }
    
            return html;
        }

        // ÊôÇÈñìÂ∑Æ„ÇíË®àÁÆó
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
    
            if (diffMins < 60) return `${diffMins}ÂàÜÂâç`;
            if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
            return `${diffDays}Êó•Ââç`;
        }

        // SNSÊäïÁ®ø„ÇíÂê´„ÇÄË©≥Á¥∞„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showDetailModalWithSocial(place, socialPostsHTML) {
            if (currentModal) {
                document.body.removeChild(currentModal);
            }

            const modal = document.createElement('div');
            modal.className = 'modal';

            const categoryNames = { gyoza: 'È§ÉÂ≠ê', cocktail: '„Ç´„ÇØ„ÉÜ„É´', jazz: '„Ç∏„É£„Ç∫' };
            const stars = '‚òÖ'.repeat(Math.floor(place.rating)) + '‚òÜ'.repeat(5 - Math.floor(place.rating));

            // ‰∫∫Ê∞ó„É°„Éã„É•„ÉºHTML
            const menusHtml = place.popular_menus && place.popular_menus.length > 0 ? 
                place.popular_menus.map(menu => 
                    `<div class="menu-item">
                        <span class="menu-name">${menu.name}</span>
                        <span class="menu-price">${menu.price}</span>
                    </div>`
                ).join('') : '<p style="color: #999;">„É°„Éã„É•„ÉºÊÉÖÂ†±„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';

            // Âè£„Ç≥„ÉüHTML
            const reviewsHtml = place.recent_reviews && place.recent_reviews.length > 0 ?
                place.recent_reviews.map(review => 
                    `<div class="review-mini">
                        <div class="review-mini-header">
                            <span>${review.author_name}</span>
                            <span class="review-mini-rating">${'‚òÖ'.repeat(review.rating)}</span>
                        </div>
                        <p>${review.content.substring(0, 50)}...</p>
                    </div>`
                ).join('') : '<p style="color: #999;">Âè£„Ç≥„Éü„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="modal-close" onclick="closePlaceModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="place-card-modal">
                            <div class="card-header">
                                <div>
                                    <div class="place-name">${place.name}</div>
                                    <div class="rating">
                                        <span class="stars">${stars}</span>
                                        <span>${place.rating} (${place.review_count || place.reviews})</span>
                                    </div>
                                </div>
                                <span class="category-badge category-${place.category}">${categoryNames[place.category]}</span>
                            </div>
            
                            <div class="detail-priority-info">
                                <div class="priority-item">
                                    <strong>‚è±Ô∏è ÊªûÂú®ÁõÆÂÆâ</strong>
                                    <span>${place.stay_time || place.timeRecommendation}</span>
                                </div>
                                <div class="priority-item">
                                    <strong>üìä Ê∑∑ÈõëÁä∂Ê≥Å</strong>
                                    <span>${place.realtime_info || place.realtimeInfo}</span>
                                </div>
                            </div>
                    
                            ${socialPostsHTML ? `
                                <div class="detail-section">
                                    <h4>üì± SNSÊúÄÊñ∞ÊÉÖÂ†±</h4>
                                    ${socialPostsHTML}
                                </div>
                            ` : ''}
            
                            <div class="detail-section">
                                <h4>‰∫∫Ê∞ó„É°„Éã„É•„Éº</h4>
                                <div class="menu-list">${menusHtml}</div>
                            </div>
            
                            <div class="detail-section">
                                <h4>ÊúÄËøë„ÅÆÂè£„Ç≥„Éü</h4>
                                <div class="reviews-mini">${reviewsHtml}</div>
                                <button class="btn-secondary" onclick="showReviews('${place.id}', '${place.name}')" style="width: 100%; margin-top: 10px;">
                                    „Åô„Åπ„Å¶„ÅÆÂè£„Ç≥„Éü„ÇíË¶ã„Çã
                                </button>
                            </div>
            
                            <div class="detail-description">
                                <p>${place.description || 'Â∫óËàóÊÉÖÂ†±„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'}</p>
                            </div>
            
                            <div class="action-buttons">
                                <button class="btn-primary" onclick="window.open('${place.google_maps_url}', '_blank')">
                                    üó∫Ô∏è Google Maps„ÅßË¶ã„Çã
                                </button>
                                <button class="btn-secondary" onclick="showReviewForm('${place.id}', '${place.name}')">
                                    ‚úèÔ∏è Âè£„Ç≥„Éü„ÇíÊõ∏„Åè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            currentModal = modal;

            // ËÉåÊôØ„Çø„ÉÉ„Éó„ÅßÈñâ„Åò„Çã(„Çπ„Éû„ÉõÂØæÂøú)
            modal.addEventListener('touchstart', (e) => {
                if (e.target === modal) {
                    closePlaceModal();
                }
            }, { passive: true });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlaceModal();
                }
            });

            // „É¢„Éº„ÉÄ„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„Ç§„Éô„É≥„Éà‰ºùÊí≠„ÇíÂÅúÊ≠¢
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                }, { passive: true });
        
                modalContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        function showDetailModal(place) {
            if (currentModal) {
                document.body.removeChild(currentModal);
            }
    
            const modal = document.createElement('div');
            modal.className = 'modal';
    
            const categoryNames = { gyoza: 'È§ÉÂ≠ê', cocktail: '„Ç´„ÇØ„ÉÜ„É´', jazz: '„Ç∏„É£„Ç∫' };
            const stars = '‚òÖ'.repeat(Math.floor(place.rating)) + '‚òÜ'.repeat(5 - Math.floor(place.rating));
    
            // ‰∫∫Ê∞ó„É°„Éã„É•„ÉºHTML
            const menusHtml = place.popular_menus && place.popular_menus.length > 0 ? 
                place.popular_menus.map(menu => 
                    `<div class="menu-item">
                        <span class="menu-name">${menu.name}</span>
                        <span class="menu-price">${menu.price}</span>
                    </div>`
                ).join('') : '<p style="color: #999;">„É°„Éã„É•„ÉºÊÉÖÂ†±„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    
            // Âè£„Ç≥„ÉüHTML
            const reviewsHtml = place.recent_reviews && place.recent_reviews.length > 0 ?
                place.recent_reviews.map(review => 
                    `<div class="review-mini">
                        <div class="review-mini-header">
                            <span>${review.author_name}</span>
                            <span class="review-mini-rating">${'‚òÖ'.repeat(review.rating)}</span>
                        </div>
                        <p>${review.content.substring(0, 50)}...</p>
                        </div>`
                ).join('') : '<p style="color: #999;">Âè£„Ç≥„Éü„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="modal-close" onclick="closePlaceModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="place-card-modal">
                            <div class="card-header">
                                <div>
                                    <div class="place-name">${place.name}</div>
                                    <div class="rating">
                                        <span class="stars">${stars}</span>
                                        <span>${place.rating} (${place.review_count || place.reviews})</span>
                                    </div>
                                </div>
                                <span class="category-badge category-${place.category}">${categoryNames[place.category]}</span>
                            </div>
                    
                            <div class="detail-priority-info">
                                <div class="priority-item">
                                    <strong>‚è±Ô∏è ÊªûÂú®ÁõÆÂÆâ</strong>
                                    <span>${place.stay_time || place.timeRecommendation}</span>
                                </div>
                                <div class="priority-item">
                                    <strong>üìä Ê∑∑ÈõëÁä∂Ê≥Å</strong>
                                    <span>${place.realtime_info || place.realtimeInfo}</span>
                                </div>
                            </div>
                    
                            <div class="detail-section">
                                <h4>‰∫∫Ê∞ó„É°„Éã„É•„Éº</h4>
                                <div class="menu-list">${menusHtml}</div>
                            </div>
                    
                            <div class="detail-section">
                                <h4>ÊúÄËøë„ÅÆÂè£„Ç≥„Éü</h4>
                                <div class="reviews-mini">${reviewsHtml}</div>
                                <button class="btn-secondary" onclick="showReviews('${place.id}', '${place.name}')" style="width: 100%; margin-top: 10px;">
                                    „Åô„Åπ„Å¶„ÅÆÂè£„Ç≥„Éü„ÇíË¶ã„Çã
                                </button>
                            </div>
                    
                            <div class="detail-description">
                                <p>${place.description || 'Â∫óËàóÊÉÖÂ†±„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'}</p>
                            </div>
                    
                            <div class="action-buttons">
                                <button class="btn-primary" onclick="window.open('${place.google_maps_url}', '_blank')">
                                    üó∫Ô∏è Google Maps„ÅßË¶ã„Çã
                                </button>
                                <button class="btn-secondary" onclick="showReviewForm('${place.id}', '${place.name}')">
                                    Âè£„Ç≥„Éü„ÇíÊõ∏„Åè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
    
            document.body.appendChild(modal);
            currentModal = modal;
    
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closePlaceModal();
            });
        }

        
        // ‚òÖ‚òÖ‚òÖ „Åì„Åì„Åæ„ÅßËøΩÂä† ‚òÖ‚òÖ‚òÖ

        function showPlaceModal(place) {
            if (currentModal) {
                document.body.removeChild(currentModal);
            }
            
            const modal = createPlaceModal(place);
            document.body.appendChild(modal);
            currentModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlaceModal();
                }
            });
            
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    closePlaceModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // „É¢„Éº„ÉÄ„É´„Åã„Çâ„É´„Éº„Éà„Å´ËøΩÂä†
        function addToRoute(placeId) {
            closePlaceModal();
    
            let foundPlace = null;
            Object.values(samplePlaces).forEach(categoryPlaces => {
                categoryPlaces.forEach(place => {
                    if (place.id === placeId) {
                        foundPlace = place;
                    }
                });
            });
    
            if (foundPlace && !selectedPlacesForRoute.find(p => p.id === placeId)) {
                selectedPlacesForRoute.push(foundPlace);
                updateSelectedPlacesDisplay();
        
                if (!isRouteMode) {
                    toggleRouteMode();
                }
        
                showToast(`üìç ${foundPlace.name}„Çí„É´„Éº„Éà„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü`);
            } else if (selectedPlacesForRoute.find(p => p.id === placeId)) {
                showToast('‚ö†Ô∏è Êó¢„Å´„É´„Éº„Éà„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            }
        }
        
        function createPlaceModal(place) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            const categoryClass = `category-${place.category}`;
            const statusClass = `status-${place.status}`;
            const stars = '‚òÖ'.repeat(Math.floor(place.rating)) + '‚òÜ'.repeat(5 - Math.floor(place.rating));
            
            const categoryNames = {
                gyoza: 'È§ÉÂ≠ê',
                cocktail: '„Ç´„ÇØ„ÉÜ„É´',
                jazz: '„Ç∏„É£„Ç∫'
            };
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="modal-close" onclick="closePlaceModal()" aria-label="„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="place-card-modal">
                            <div class="card-header">
                                <div>
                                    <div class="place-name">${place.name}</div>
                                    <div class="rating">
                                        <span class="stars">${stars}</span>
                                        <span>${place.rating} (${place.reviews.toLocaleString()})</span>
                                    </div>
                                </div>
                                <div>
                                    <span class="category-badge ${categoryClass}">${categoryNames[place.category]}</span>
                                    <span class="status-badge ${statusClass}">${place.statusText}</span>
                                </div>
                            </div>
                            
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-icon">üìç</div>
                                    <span>${place.distance} | ÂæíÊ≠©${place.walkTime}</span>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">‚è∞</div>
                                    <span>ÂæÖ„Å°: ${place.waitTime}</span>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">üí∞</div>
                                    <span>${place.priceRange}</span>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">${place.category === 'gyoza' ? 'ü•ü' : place.category === 'cocktail' ? 'üç∏' : 'üé∑'}</div>
                                    <span>${place.specialty}</span>
                                </div>
                            </div>
                            
                            <div class="realtime-info">
                                <h4>üì° ÁèæÂú®ÊÉÖÂ†± <small>3ÂàÜÂâçÊõ¥Êñ∞</small></h4>
                                <p>${place.realtimeInfo}</p>
                            </div>
                            
                            <div class="social-feedback" onclick="showReviews('${place.id}', '${place.name}')">
                                <h4>üí¨ „Åø„Çì„Å™„ÅÆÂè£„Ç≥„Éü</h4>
                                <p>„Åì„ÅÆ„ÅäÂ∫ó„ÅÆÂè£„Ç≥„Éü„ÇíË¶ã„ÇãÔºà„Çø„ÉÉ„Éó„Åß‰∏ÄË¶ßË°®Á§∫Ôºâ</p>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn-primary" onclick="selectPlace('${place.name}', '${place.category}')">
                                    „Åì„ÅÆÂ†¥ÊâÄ„Å´Ê±∫ÂÆö
                                </button>
                                <button class="btn-secondary" onclick="addToRoute('${place.id}')">
                                    „É´„Éº„Éà„Å´ËøΩÂä†
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return modal;
        }
        
        function closePlaceModal() {
            if (currentModal) {
                document.body.removeChild(currentModal);
                currentModal = null;
            }
        }
        
        async function showReviews(placeId, placeName) {
            closePlaceModal();
    
            const modal = document.createElement('div');
            modal.className = 'modal';
    
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="margin: 0; color: #333; font-size: 18px;">${placeName} „ÅÆÂè£„Ç≥„Éü</h2>
                        <button class="modal-close" onclick="closePlaceModal()" aria-label="Âè£„Ç≥„Éü„ÇíÈñâ„Åò„Çã">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Âè£„Ç≥„Éü„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                        </div>
                    </div>
                </div>
            `;
    
            document.body.appendChild(modal);
            currentModal = modal;
    
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlaceModal();
                }
            });
    
            try {
                // „Åì„ÅÆÂ∫óËàó„ÅÆÂè£„Ç≥„Éü„ÅÆ„Åø„ÇíÂèñÂæó
                const response = await fetch(`${API_URL}/reviews?place_id=${placeId}`);
                const allReviews = await response.json();
        
                displayReviews(allReviews, placeId, placeName);
            } catch (error) {
                console.error('Âè£„Ç≥„ÉüÂèñÂæó„Ç®„É©„Éº:', error);
                displayReviewsError(placeId, placeName);
            }
        }
        
        function displayReviews(reviews, placeId, placeName) {
            const modalBody = currentModal.querySelector('.modal-body');
            
            if (reviews.length === 0) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #666; margin-bottom: 20px;">„Åæ„Å†Âè£„Ç≥„Éü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        <button class="btn-primary" onclick="showReviewForm('${placeId}', '${placeName}')" style="width: auto; padding: 12px 24px;">
                            ÊúÄÂàù„ÅÆÂè£„Ç≥„Éü„ÇíÊäïÁ®ø„Åô„Çã
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn-secondary" onclick="closePlaceModal(); setTimeout(() => findPlaceById('${placeId}'), 100);" style="width: auto; padding: 10px 20px;">
                            Â∫óËàóÊÉÖÂ†±„Å´Êàª„Çã
                        </button>
                    </div>
                `;
                return;
            }
            
            const reviewsHTML = reviews.map(review => {
                const isVoted = votedReviews[review.id] || false;
                return `
                    <div class="review-item" data-review-id="${review.id}">
                        <div class="review-header">
                            <span class="review-author">${escapeHtml(review.author_name)}</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="review-date">${formatDate(review.created_at)}</span>
                                <button onclick="showDeleteConfirm(${review.id}, '${escapeHtml(review.author_name)}')" 
                                        style="background: #ff4444; color: white; border: none; 
                                               padding: 4px 10px; border-radius: 12px; cursor: pointer;
                                               font-size: 11px; transition: all 0.3s ease;"
                                        onmouseover="this.style.background='#cc0000'"
                                        onmouseout="this.style.background='#ff4444'">
                                    üóëÔ∏è ÂâäÈô§
                                </button>
                            </div>
                        </div>
                        <div class="review-rating">${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}</div>
                        <div class="review-text">${escapeHtml(review.content)}</div>
                        ${review.image_path ? `<img src="${review.image_path}" class="review-image" alt="Âè£„Ç≥„ÉüÁîªÂÉè">` : ''}
                        <button class="helpful-button ${isVoted ? 'voted' : ''}" onclick="markHelpful(${review.id}, this)">
                            üëç ÂèÇËÄÉ„Å´„Å™„Å£„Åü (${review.helpful_count})
                        </button>
                    </div>
                `;
            }).join('');
            
            modalBody.innerHTML = `
                <div class="reviews-list">
                    ${reviewsHTML}
                </div>
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                    <button class="btn-primary" onclick="showReviewForm('${placeId}', '${placeName}')" style="width: auto; padding: 10px 20px; margin-bottom: 10px;">
                        Âè£„Ç≥„Éü„ÇíÊäïÁ®ø„Åô„Çã
                    </button>
                    <br>
                    <button class="btn-secondary" onclick="closePlaceModal(); setTimeout(() => findPlaceById('${placeId}'), 100);" style="width: auto; padding: 10px 20px;">
                        Â∫óËàóÊÉÖÂ†±„Å´Êàª„Çã
                    </button>
                </div>
            `;
        }
        
        function showDeleteConfirm(reviewId, authorName) {
            const deleteModal = document.createElement('div');
            deleteModal.className = 'modal';
            deleteModal.style.zIndex = '10000';
            
            deleteModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2 style="margin: 0; color: #333; font-size: 18px;">üóëÔ∏è Âè£„Ç≥„Éü„ÇíÂâäÈô§</h2>
                    </div>
                    <div class="modal-body">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <p style="color: #856404; margin: 0; font-size: 14px; line-height: 1.6;">
                                ‚ö†Ô∏è „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ<br>
                                Âè£„Ç≥„Éü„Å®Ê∑ª‰ªòÁîªÂÉè„ÅåÂÆåÂÖ®„Å´ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ
                            </p>
                        </div>
                        
                        <form id="deleteForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">
                                    ÂâäÈô§ÊñπÊ≥ï„ÇíÈÅ∏Êäû
                                </label>
                                <select id="deleteMethod" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="author">ÊäïÁ®øËÄÖ„Å®„Åó„Å¶ÂâäÈô§</option>
                                    <option value="admin">ÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶ÂâäÈô§</option>
                                </select>
                            </div>
                            
                            <div id="authorField" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">
                                    ÊäïÁ®øËÄÖÂêç„ÇíÂÖ•Âäõ
                                </label>
                                <input type="text" id="deleteAuthorName" placeholder="ÊäïÁ®øÊôÇ„ÅÆÂêçÂâç" 
                                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <small style="color: #666; font-size: 12px;">‚Äª ÊäïÁ®øÊôÇ„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                            </div>
                            
                            <div id="adminField" style="margin-bottom: 15px; display: none;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">
                                    ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ
                                </label>
                                <input type="password" id="deleteAdminPassword" placeholder="ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ" 
                                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            
                            <div id="deleteMessage" style="margin-bottom: 15px;"></div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" style="
                                    flex: 1; background: #ff4444; color: white; border: none;
                                    padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;
                                    transition: all 0.3s ease;
                                ">ÂâäÈô§„Åô„Çã</button>
                                <button type="button" onclick="this.closest('.modal').remove()" style="
                                    flex: 1; background: #e2e8f0; color: #4a5568; border: none;
                                    padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;
                                ">„Ç≠„É£„É≥„Çª„É´</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deleteModal);
            
            // ÂâäÈô§ÊñπÊ≥ï„ÅÆÂàá„ÇäÊõø„Åà
            const methodSelect = deleteModal.querySelector('#deleteMethod');
            const authorField = deleteModal.querySelector('#authorField');
            const adminField = deleteModal.querySelector('#adminField');
            
            methodSelect.addEventListener('change', function() {
                if (this.value === 'admin') {
                    authorField.style.display = 'none';
                    adminField.style.display = 'block';
                } else {
                    authorField.style.display = 'block';
                    adminField.style.display = 'none';
                }
            });
            
            // ÂâäÈô§„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
            const deleteForm = deleteModal.querySelector('#deleteForm');
            deleteForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const method = methodSelect.value;
                const messageDiv = deleteModal.querySelector('#deleteMessage');
                
                let requestBody = {};
                
                if (method === 'author') {
                    const inputName = deleteModal.querySelector('#deleteAuthorName').value.trim();
                    if (!inputName) {
                        messageDiv.innerHTML = '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">ÊäïÁ®øËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                        return;
                    }
                    requestBody.author_name = inputName;
                } else {
                    const password = deleteModal.querySelector('#deleteAdminPassword').value;
                    if (!password) {
                        messageDiv.innerHTML = '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                        return;
                    }
                    requestBody.admin_password = password;
                }
                
                messageDiv.innerHTML = '<div style="text-align: center; color: #667eea;">ÂâäÈô§‰∏≠...</div>';
                
                try {
                    const response = await fetch(`${API_URL}/reviews/${reviewId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        messageDiv.innerHTML = '<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 8px; text-align: center;">ÂâäÈô§„Åó„Åæ„Åó„Åü</div>';
                        
                        // ÂâäÈô§„Åï„Çå„Åü„É¨„Éì„É•„Éº„ÇíDOM„Åã„ÇâÂâäÈô§
                        const reviewElement = document.querySelector(`[data-review-id="${reviewId}"]`);
                        if (reviewElement) {
                            reviewElement.style.animation = 'fadeOut 0.5s ease forwards';
                            setTimeout(() => reviewElement.remove(), 500);
                        }
                        
                        setTimeout(() => {
                            deleteModal.remove();
                        }, 1500);
                    } else {
                        messageDiv.innerHTML = `<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">${data.error || 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'}</div>`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    messageDiv.innerHTML = '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
                }
            });
            
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) {
                    deleteModal.remove();
                }
            });
        }
        
        function displayReviewsError(placeId, placeName) {
            const modalBody = currentModal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p style="color: #666; margin-bottom: 20px;">Âè£„Ç≥„Éü„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                    <p style="color: #999; font-size: 14px; margin-bottom: 20px;">„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ<br>Âè£„Ç≥„ÉüÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅNode.js„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <button class="btn-secondary" onclick="closePlaceModal(); setTimeout(() => findPlaceById('${placeId}'), 100);">
                        Â∫óËàóÊÉÖÂ†±„Å´Êàª„Çã
                    </button>
                </div>
            `;
        }
        
        async function markHelpful(reviewId, button) {
            if (button.classList.contains('voted')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/reviews/${reviewId}/helpful`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    button.classList.add('voted');
                    votedReviews[reviewId] = true;
                    const currentCount = parseInt(button.textContent.match(/\d+/)[0]);
                    button.textContent = `üëç ÂèÇËÄÉ„Å´„Å™„Å£„Åü (${currentCount + 1})`;
                } else {
                    alert(data.error || 'Êó¢„Å´ÊäïÁ•®Ê∏à„Åø„Åß„Åô');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }
        
        function showReviewForm(placeId, placeName) {
            console.log('üè™ showReviewForm Âëº„Å≥Âá∫„Åó:', { placeId, placeName }); // ‚Üê „Éá„Éê„ÉÉ„Ç∞Áî®
    
            if (!placeId) {
                alert('„Ç®„É©„Éº: Â∫óËàóID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                return;
            }
    
            closePlaceModal();
    
            const modal = document.createElement('div');
            modal.className = 'modal';
    
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="margin: 0; color: #333; font-size: 18px;">‚úèÔ∏è ${placeName} „ÅÆÂè£„Ç≥„Éü„ÇíÊäïÁ®ø</h2>
                        <button class="modal-close" onclick="closePlaceModal()" aria-label="ÊäïÁ®ø„Éï„Ç©„Éº„É†„ÇíÈñâ„Åò„Çã">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="reviewForm" style="padding: 10px 0;">
                            <!-- Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„Å®„Åó„Å¶ place_id „Çí‰øùÊåÅ -->
                            <input type="hidden" id="placeIdHidden" value="${placeId}">
                    
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">„ÅäÂêçÂâç *</label>
                                <input type="text" id="authorName" required placeholder="Â±±Áî∞Â§™ÈÉé" style="
                                    width: 100%; padding: 10px; border: 2px solid #e0e0e0;
                                    border-radius: 8px; font-size: 14px;
                                ">
                            </div>
                    
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Ë©ï‰æ° *</label>
                                <div style="display: flex; gap: 10px; flex-direction: row-reverse; justify-content: flex-end; font-size: 30px;">
                                    <input type="radio" id="star5" name="rating" value="5" required style="display: none;">
                                    <label for="star5" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</label>
                                    <input type="radio" id="star4" name="rating" value="4" style="display: none;">
                                    <label for="star4" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</label>
                                    <input type="radio" id="star3" name="rating" value="3" style="display: none;">
                                    <label for="star3" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</label>
                                    <input type="radio" id="star2" name="rating" value="2" style="display: none;">
                                    <label for="star2" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</label>
                                    <input type="radio" id="star1" name="rating" value="1" style="display: none;">
                                    <label for="star1" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</label>
                                </div>
                            </div>
                    
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Âè£„Ç≥„ÉüÂÜÖÂÆπ *</label>
                                <textarea id="content" required placeholder="„ÅîÊÑüÊÉ≥„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ..." style="
                                    width: 100%; min-height: 100px; padding: 10px; border: 2px solid #e0e0e0;
                                    border-radius: 8px; font-size: 14px; resize: vertical;
                                "></textarea>
                            </div>
                    
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ÁîªÂÉè„ÇíÊ∑ª‰ªò (‰ªªÊÑè)</label>
                                <input type="file" id="imageInput" accept="image/*" style="
                                    padding: 10px; border: 2px dashed #ccc; border-radius: 8px;
                                    width: 100%; cursor: pointer;
                                ">
                                <img id="previewImage" style="max-width: 200px; max-height: 200px; margin-top: 10px; border-radius: 8px; display: none;">
                            </div>
                    
                            <div id="formMessage" style="margin-bottom: 15px;"></div>
                    
                            <button type="submit" class="btn-primary" style="width: 100%;">
                                Âè£„Ç≥„Éü„ÇíÊäïÁ®ø
                            </button>
                            <button type="button" class="btn-secondary" onclick="closePlaceModal(); setTimeout(() => showReviews('${placeId}', '${placeName}'), 100);" style="width: 100%; margin-top: 10px;">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </form>
                    </div>
                </div>
            `;
    
            document.body.appendChild(modal);
            currentModal = modal;
    
            // ÊòüË©ï‰æ°„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
            const ratingInputs = modal.querySelectorAll('input[name="rating"]');
            const ratingLabels = modal.querySelectorAll('label[for^="star"]');
    
            ratingInputs.forEach((input, index) => {
                input.addEventListener('change', function() {
                    ratingLabels.forEach((label, i) => {
                        if (i >= ratingInputs.length - index - 1) {
                            label.style.color = '#ffd700';
                        } else {
                            label.style.color = '#ddd';
                        }
                    });
                });
            });
    
            ratingLabels.forEach((label, index) => {
                label.addEventListener('mouseenter', function() {
                    for (let i = ratingLabels.length - 1; i >= ratingLabels.length - index - 1; i--) {
                        ratingLabels[i].style.color = '#ffd700';
                    }
                });
        
                label.addEventListener('mouseleave', function() {
                    const checked = modal.querySelector('input[name="rating"]:checked');
                    if (checked) {
                        const checkedIndex = Array.from(ratingInputs).indexOf(checked);
                        ratingLabels.forEach((l, i) => {
                            l.style.color = i >= ratingInputs.length - checkedIndex - 1 ? '#ffd700' : '#ddd';
                        });
                    } else {
                        ratingLabels.forEach(l => l.style.color = '#ddd');
                    }
                });
            });
    
            // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº
            const imageInput = modal.querySelector('#imageInput');
            const previewImage = modal.querySelector('#previewImage');
    
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImage.style.display = 'none';
                }
            });
    
            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
            const form = modal.querySelector('#reviewForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
        
                // Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„Åã„Çâ place_id „ÇíÂèñÂæó
                const hiddenPlaceId = modal.querySelector('#placeIdHidden').value;
                console.log('üìù „Éï„Ç©„Éº„É†ÈÄÅ‰ø° place_id:', hiddenPlaceId); // ‚Üê „Éá„Éê„ÉÉ„Ç∞Áî®
        
                const formData = new FormData();
                formData.append('place_id', hiddenPlaceId);
                formData.append('author_name', modal.querySelector('#authorName').value);
                formData.append('content', modal.querySelector('#content').value);
                formData.append('rating', modal.querySelector('input[name="rating"]:checked').value);
        
                const imageFile = modal.querySelector('#imageInput').files[0];
                if (imageFile) {
                    formData.append('image', imageFile);
                }
        
                // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÈÄÅ‰ø°ÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
                console.log('üì§ ÈÄÅ‰ø°„Éá„Éº„Çø:');
                for (let [key, value] of formData.entries()) {
                    console.log(`  ${key}:`, value);
                }
        
                const messageDiv = modal.querySelector('#formMessage');
                messageDiv.innerHTML = '<div style="text-align: center; color: #667eea;">ÊäïÁ®ø‰∏≠...</div>';
        
                try {
                    const response = await fetch(`${API_URL}/reviews`, {
                    method: 'POST',
                    body: formData
                    });
            
                    const data = await response.json();
            
                    if (response.ok) {
                        messageDiv.innerHTML = '<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 8px; text-align: center;">Âè£„Ç≥„Éü„ÇíÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ</div>';
                        setTimeout(() => {
                            closePlaceModal();
                            setTimeout(() => showReviews(hiddenPlaceId, placeName), 100);
                        }, 1500);
                    } else {
                        messageDiv.innerHTML = `<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">${data.error || 'ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'}</div>`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    messageDiv.innerHTML = '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
                }
            });
    
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlaceModal();
                }
            });
        }
        
        function findPlaceById(placeId) {
            let foundPlace = null;
            Object.values(samplePlaces).forEach(categoryPlaces => {
                categoryPlaces.forEach(place => {
                    if (place.id === placeId) {
                        foundPlace = place;
                    }
                });
            });
            
            if (foundPlace) {
                showPlaceModal(foundPlace);
            }
        }
        
        function selectPlace(name, category) {
            const categoryNames = {
                gyoza: 'È§ÉÂ≠ê',
                cocktail: '„Ç´„ÇØ„ÉÜ„É´', 
                jazz: '„Ç∏„É£„Ç∫'
            };
            
            closePlaceModal();
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 30px; border-radius: 20px;
                text-align: center; max-width: 90%; width: 350px;
                z-index: 10000; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            notification.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 15px;">üéâ</div>
                <h2 style="margin-bottom: 10px; color: #667eea;">Ê±∫ÂÆö„Åó„Åæ„Åó„ÅüÔºÅ</h2>
                <p style="margin-bottom: 15px; font-size: 16px; font-weight: 600;">
                    ${name}<br>
                    <span style="color: #666; font-size: 14px;">${categoryNames[category]}‰ΩìÈ®ì</span>
                </p>
                <div style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 10px; font-size: 13px; color: #555; line-height: 1.4;">
                    ‚úì „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÈñãÂßã<br>
                    ‚úì ÁèæÂú®„ÅÆÊ∑∑ÈõëÁä∂Ê≥Å„ÇíÁ∂ôÁ∂öÁõ£Ë¶ñ<br>
                    ‚úì Èñ¢ÈÄ£„Çπ„Éù„ÉÉ„Éà„ÇÇÊèêÊ°à„Åó„Åæ„Åô
                </div>
                <button onclick="this.closest('div').remove()" style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white; border: none; padding: 12px 25px;
                    border-radius: 25px; font-weight: 600; cursor: pointer;
                    transition: transform 0.2s ease; width: 100%;
                ">
                    ÂÆáÈÉΩÂÆÆ„ÇíÊ•Ω„Åó„ÇÇ„ÅÜÔºÅ
                </button>
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popIn {
                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'popOut 0.3s ease forwards';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }
        
        function showDetails(name, category) {
            const categoryNames = {
                gyoza: 'È§ÉÂ≠ê',
                cocktail: '„Ç´„ÇØ„ÉÜ„É´',
                jazz: '„Ç∏„É£„Ç∫'
            };
            
            closePlaceModal();
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="margin: 0; color: #333; font-size: 18px;">üìã ${name} „ÅÆË©≥Á¥∞ÊÉÖÂ†±</h2>
                        <button class="modal-close" onclick="closePlaceModal()" aria-label="Ë©≥Á¥∞ÊÉÖÂ†±„ÇíÈñâ„Åò„Çã">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px; color: #333;">üè™ Â∫óËàóË©≥Á¥∞</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; font-size: 14px; line-height: 1.6;">
                                ‚Ä¢ „Ç´„ÉÜ„Ç¥„É™„Éº: ${categoryNames[category]}<br>
                                ‚Ä¢ Âñ∂Ê•≠ÊôÇÈñì: 18:00„Äú24:00 (Êúà„ÄúÂúü)<br>
                                ‚Ä¢ ÈõªË©±Áï™Âè∑: 028-XXX-XXXX<br>
                                ‚Ä¢ Â∫ßÂ∏≠Êï∞: „Ç´„Ç¶„É≥„Çø„Éº12Â∏≠„ÄÅ„ÉÜ„Éº„Éñ„É´20Â∏≠<br>
                                ‚Ä¢ Á¶ÅÁÖô„ÉªÂñ´ÁÖô: ÂÆåÂÖ®Á¶ÅÁÖô<br>
                                ‚Ä¢ ÊîØÊâï„ÅÑ: ÁèæÈáë„ÄÅÂêÑÁ®Æ„Ç´„Éº„Éâ„ÄÅÈõªÂ≠ê„Éû„Éç„Éº
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 10px; color: #333;">üéØ ÁâπÂæ¥„Éª„Åì„Å†„Çè„Çä</h3>
                            <div style="background: #fff8e1; padding: 15px; border-radius: 10px; font-size: 14px; line-height: 1.6;">
                                ÂâµÊ•≠„Åã„ÇâÂèó„ÅëÁ∂ô„Åå„Çå„Çã‰ºùÁµ±ÁöÑ„Å™${categoryNames[category]}„Å•„Åè„Çä„Å®„ÄÅ
                                Áèæ‰ª£ÁöÑ„Å™„Ç¢„É¨„É≥„Ç∏„ÇíËûçÂêà„Åó„ÅüÁã¨Ëá™„ÅÆ„Çπ„Çø„Ç§„É´„ÄÇ
                                Âú∞ÂÖÉ„ÅÆÈ£üÊùê„Å´„Åì„Å†„Çè„Çä„ÄÅËÅ∑‰∫∫„ÅÆÊäÄË°ì„ÅåÂÖâ„Çã‰∏ÄÂìÅ‰∏ÄÂìÅ„ÇíÊèê‰æõ„ÄÇ
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="selectPlace('${name}', '${category}');" style="
                                flex: 1; background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white; border: none; padding: 12px;
                                border-radius: 8px; font-weight: 600; cursor: pointer;
                            ">„Åì„ÅÆÂ†¥ÊâÄ„Å´Ê±∫ÂÆö</button>
                            <button onclick="closePlaceModal()" style="
                                background: #e2e8f0; color: #4a5568; border: none;
                                padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
                            ">Èñâ„Åò„Çã</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            currentModal = modal;
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePlaceModal();
                }
            });
        }
        
        function zoomIn() {
            map.zoomIn();
            showToast('üîç Êã°Â§ß„Åó„Åæ„Åó„Åü');
        }

        function zoomOut() {
            map.zoomOut();
            showToast('üîç Á∏ÆÂ∞è„Åó„Åæ„Åó„Åü');
        }

        function resetView() {
            map.setView([36.5579, 139.8984], 14);
            showToast('üè† Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        let touchStartY = 0;
        let touchStartX = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
        });
        
        document.addEventListener('touchmove', function(e) {
            if (currentModal) {
                const touchY = e.touches[0].clientY;
                const touchX = e.touches[0].clientX;
                const diffY = touchStartY - touchY;
                const diffX = touchStartX - touchX;
                
                if (diffY < -100 && Math.abs(diffX) < 50) {
                    closePlaceModal();
                }
            }
        });
        
        function optimizeForMobile() {
            if (window.innerWidth <= 768) {
                const particles = document.querySelectorAll('.particle');
                particles.forEach((particle, index) => {
                    if (index % 2 === 0) {
                        particle.remove();
                    }
                });
            }
            
            const map = document.getElementById('map');
            map.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
        }
        
        window.addEventListener('load', () => {
            optimizeForMobile();
            
            window.addEventListener('resize', () => {
                optimizeForMobile();
            });
        });
        
        const additionalStyles = document.createElement('style');
        additionalStyles.textContent = `
            @keyframes popOut {
                0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            }
            
            .modal-content {
                -webkit-overflow-scrolling: touch;
            }
            
            @media (max-width: 768px) {
                .map-pin {
                    padding: 5px;
                }
                
                .category-filter-btn,
                .map-control-btn,
                .settings-toggle {
                    min-height: 44px;
                    min-width: 44px;
                }
                
                .btn-primary,
                .btn-secondary,
                .quick-action-btn {
                    min-height: 44px;
                    font-size: 16px;
                }
            }
        `;
        document.head.appendChild(additionalStyles);
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // „É´„Éº„Éà„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleRouteMode() {
            isRouteMode = !isRouteMode;
            const routePanel = document.getElementById('routePanel');
    
            if (isRouteMode) {
                routePanel.classList.add('active');
                showToast('üó∫Ô∏è „É´„Éº„Éà‰ΩúÊàê„É¢„Éº„Éâ: Ë®™Âïè„Åó„Åü„ÅÑÂ†¥ÊâÄ„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            } else {
                routePanel.classList.remove('active');
                clearRouteSelection();
                showToast('ÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Çä„Åæ„Åó„Åü');
            }
        }

        // Â†¥ÊâÄ„Çí„É´„Éº„Éà„Å´ËøΩÂä†/ÂâäÈô§
        function togglePlaceSelection(place) {
            const index = selectedPlacesForRoute.findIndex(p => p.id === place.id);
    
            if (index === -1) {
                selectedPlacesForRoute.push(place);
                showToast(`üìç ${place.name}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
            } else {
                selectedPlacesForRoute.splice(index, 1);
                showToast(`‚ùå ${place.name}„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
            }
    
            updateSelectedPlacesDisplay();
        }

        // ÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥ÊâÄ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateSelectedPlacesDisplay() {
            const container = document.getElementById('selectedPlaces');
    
            if (selectedPlacesForRoute.length === 0) {
                container.innerHTML = '<small style="color: #999;">Â†¥ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>';
                return;
            }
    
            container.innerHTML = selectedPlacesForRoute.map(place => `
                <div class="selected-place-tag">
                    ${place.name}
                <button onclick="removeFromRoute('${place.id}')">x</button>
                </div>
            `).join('');
        }

        // „É´„Éº„Éà„Åã„ÇâÂâäÈô§
        function removeFromRoute(placeId) {
            selectedPlacesForRoute = selectedPlacesForRoute.filter(p => p.id !== placeId);
            updateSelectedPlacesDisplay();
        }

        // ÊúÄÈÅ©„É´„Éº„Éà„Çí‰ΩúÊàê
        function createOptimalRoute() {
            if (selectedPlacesForRoute.length < 2) {
                showToast('‚ö†Ô∏è 2ÁÆáÊâÄ‰ª•‰∏äÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Êó¢Â≠ò„ÅÆ„É´„Éº„Éà„ÇíÂâäÈô§
            if (routeControl) {
                map.removeControl(routeControl);
            }

            // ÊúÄÈÅ©„Å™È†ÜÂ∫è„ÇíË®àÁÆóÔºàÊúÄËøëÂÇçÊ≥ï„Å´„Çà„ÇãÁ∞°ÊòìTSPÔºâ
            const optimizedRoute = optimizeRouteOrder(selectedPlacesForRoute);

            // „É´„Éº„Éà„ÅÆÂ∫ßÊ®ôÈÖçÂàó„Çí‰ΩúÊàê
            const waypoints = optimizedRoute.map(place => 
                L.latLng(place.lat, place.lng)
            );

            // Leaflet Routing Machine„Åß„É´„Éº„Éà„ÇíË°®Á§∫
            routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false,
                lineOptions: {
                    styles: [
                        {color: '#667eea', opacity: 0.8, weight: 6}
                    ]
                },
                createMarker: function() { return null; }, // „Éû„Éº„Ç´„Éº„ÅØÊó¢Â≠ò„ÅÆ„ÇÇ„ÅÆ„Çí‰ΩøÁî®
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'foot' // ÂæíÊ≠©„É´„Éº„Éà
                })
            }).addTo(map);

            showToast(`‚úÖ ${optimizedRoute.length}ÁÆáÊâÄ„ÅÆÊúÄÈÅ©„É´„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ`);
    
            // „É´„Éº„Éà„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
            isRouteMode = false;
            document.getElementById('routePanel').classList.remove('active');
        }

        // ÊúÄÈÅ©„Å™Ë®™ÂïèÈ†ÜÂ∫è„ÇíË®àÁÆóÔºàÊúÄËøëÂÇçÊ≥ïÔºâ
        function optimizeRouteOrder(places) {
            if (places.length <= 2) return places;

            const result = [places[0]];
            const remaining = places.slice(1);

            while (remaining.length > 0) {
                const current = result[result.length - 1];
                let nearestIndex = 0;
                let nearestDistance = Infinity;

                remaining.forEach((place, index) => {
                    const distance = calculateDistance(
                        current.lat, current.lng,
                        place.lat, place.lng
                    );
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestIndex = index;
                    }
                });

                result.push(remaining[nearestIndex]);
                remaining.splice(nearestIndex, 1);
            }

            return result;
        }

        // 2ÁÇπÈñì„ÅÆË∑ùÈõ¢„ÇíË®àÁÆóÔºà„Éí„É•„Éô„Éã„ÅÆÂÖ¨ÂºèÔºâ
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Âú∞ÁêÉ„ÅÆÂçäÂæÑ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // „É´„Éº„ÉàÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
        function clearRouteSelection() {
            selectedPlacesForRoute = [];
            updateSelectedPlacesDisplay();
    
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
    
            showToast('üóëÔ∏è „É´„Éº„Éà„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        }

        // „Éà„Éº„Çπ„ÉàÈÄöÁü•
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
                background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
                border-radius: 20px; font-size: 14px; z-index: 10000;
                animation: toastSlide 2s ease forwards;
            `;
            toast.textContent = message;
    
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´„Çí‰∏ÄÂ∫¶„Å†„ÅëËøΩÂä†
            if (!document.querySelector('style[data-toast]')) {
                const style = document.createElement('style');
                style.setAttribute('data-toast', 'true');
                style.textContent = `
                   @keyframes toastSlide {
                        0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                        20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
            }
    
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ============================================
        // AI„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ
        // ============================================

        let chatState = {
            step: 0,
            selectedCategories: [],
            selectedTime: '',
            selectedPurpose: '',
            messages: []
        };

        // „ÉÅ„É£„ÉÉ„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openAIChat() {
            // Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            chatState = {
                step: 0,
                selectedCategories: [],
                selectedTime: '',
                selectedPurpose: '',
                messages: []
            };
    
            // „É¢„Éº„ÉÄ„É´„Çí‰ΩúÊàê
            const modal = document.createElement('div');
            modal.className = 'ai-chat-modal';
            modal.id = 'aiChatModal';
    
            modal.innerHTML = `
                <div class="ai-chat-container">
                    <div class="ai-chat-header">
                        <h3>„Ç¶„ÉÑ„Éç„Éº„Çø„Éº</h3>
                        <button class="ai-chat-close" onclick="closeAIChat()">√ó</button>
                    </div>
                    <div class="ai-chat-messages" id="aiChatMessages"></div>
                </div>
            `;
    
            document.body.appendChild(modal);
    
            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAIChat();
                }
            });
    
            // ÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            setTimeout(() => {
                addAIMessage(appConfig.ai.greeting);
                setTimeout(() => {
                    addAIMessage(appConfig.ai.description);
                    setTimeout(() => {
                        askCategories();
                    }, 800);
                }, 800);
            }, 300);

        }

        // „ÉÅ„É£„ÉÉ„Éà„ÇíÈñâ„Åò„Çã
        function closeAIChat() {
            const modal = document.getElementById('aiChatModal');
            if (modal) {
                modal.remove();
            }
        }

        // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
        function addAIMessage(text, showOptions = false, options = []) {
            const container = document.getElementById('aiChatMessages');
    
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message';
            typingDiv.innerHTML = `
                <div class="ai-typing">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
    
            // ÂÆüÈöõ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            setTimeout(() => {
                typingDiv.remove();
        
                const messageDiv = document.createElement('div');
                messageDiv.className = 'ai-message';
                messageDiv.textContent = text;
        
                if (showOptions && options.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'ai-chat-options';
            
                    options.forEach(option => {
                        const btn = document.createElement('button');
                        btn.className = 'ai-option-btn';
                        btn.textContent = option.text;
                        btn.onclick = option.action;
                        optionsDiv.appendChild(btn);
                    });
            
                    messageDiv.appendChild(optionsDiv);
                }
        
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
        
                chatState.messages.push({ role: 'ai', text });
            }, 1000);
        }

        // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
        function addUserMessage(text) {
            const container = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'user-message';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
    
            chatState.messages.push({ role: 'user', text });
        }

        // „Çπ„ÉÜ„ÉÉ„Éó1: „Ç´„ÉÜ„Ç¥„É™„ÇíËÅû„Åè
        function askCategories() {
            const options = appConfig.categories.map(cat => ({
                text: `${cat.emoji} ${cat.name}`,
                action: () => selectCategory(cat.id)
            }));
    
            options.push({
                text: '‚ú® ÂÖ®ÈÉ®Ê•Ω„Åó„Åø„Åü„ÅÑ!',
                action: () => selectCategory('all')
            });
    
            addAIMessage(appConfig.ai.categoryPrompt, true, options);
        }

        function selectCategory(category) {
            const categoryNames = {
                'gyoza': 'ü•ü È§ÉÂ≠ê',
                'cocktail': 'üç∏ „Ç´„ÇØ„ÉÜ„É´',
                'jazz': 'üé∑ „Ç∏„É£„Ç∫',
                'all': '‚ú® ÂÖ®ÈÉ®'
            };
    
            addUserMessage(categoryNames[category]);
    
            if (category === 'all') {
                chatState.selectedCategories = ['gyoza', 'cocktail', 'jazz'];
            } else {
                chatState.selectedCategories = [category];
            }
    
            setTimeout(() => {
                addAIMessage('„ÅÑ„ÅÑ„Åß„Åô„Å≠! üëç');
                setTimeout(() => {
                    askTime();
                }, 800);
            }, 500);
        }

        // „Çπ„ÉÜ„ÉÉ„Éó2: ÊôÇÈñì„ÇíËÅû„Åè
        function askTime() {
            addAIMessage('„Å©„ÅÆ„Åè„Çâ„ÅÑÊôÇÈñì„Åå„ÅÇ„Çä„Åæ„Åô„Åã?', true, [
                { text: '‚è±Ô∏è 30ÂàÜ„Äú1ÊôÇÈñì', action: () => selectTime('30ÂàÜ„Äú1ÊôÇÈñì') },
                { text: '‚è±Ô∏è 1„Äú2ÊôÇÈñì', action: () => selectTime('1„Äú2ÊôÇÈñì') },
                { text: '‚è±Ô∏è 2„Äú3ÊôÇÈñì', action: () => selectTime('2„Äú3ÊôÇÈñì') },
                { text: '‚è±Ô∏è 3ÊôÇÈñì‰ª•‰∏ä', action: () => selectTime('3ÊôÇÈñì‰ª•‰∏ä') }
            ]);
        }

        function selectTime(time) {
            addUserMessage(time);
            chatState.selectedTime = time;
    
            setTimeout(() => {
                addAIMessage('ÊâøÁü•„Åó„Åæ„Åó„Åü! üìù');
                setTimeout(() => {
                    askPurpose();
                }, 800);
            }, 500);
        }

        // „Çπ„ÉÜ„ÉÉ„Éó3: ÁõÆÁöÑ„ÇíËÅû„Åè
        function askPurpose() {
            addAIMessage('„Å©„Çì„Å™„Ç∑„ÉÅ„É•„Ç®„Éº„Ç∑„Éß„É≥„Åß„Åô„Åã?', true, [
                { text: 'üíº Âá∫Âºµ„Éª‰ªï‰∫ãÂ∏∞„Çä', action: () => selectPurpose('Âá∫Âºµ„Éª‰ªï‰∫ãÂ∏∞„Çä') },
                { text: 'üöó Êó•Â∏∞„ÇäË¶≥ÂÖâ', action: () => selectPurpose('Êó•Â∏∞„ÇäË¶≥ÂÖâ') },
                { text: 'üöÜ ‰πó„ÇäÁ∂ô„Åé„ÉªÈÄöÈÅé', action: () => selectPurpose('‰πó„ÇäÁ∂ô„Åé„ÉªÈÄöÈÅé') },
                { text: 'üè† Âú∞ÂÖÉ„Åß„ÅÆÊôÇÈñì„Å§„Å∂„Åó', action: () => selectPurpose('Âú∞ÂÖÉ„Åß„ÅÆÊôÇÈñì„Å§„Å∂„Åó') }
            ]);
        }

        function selectPurpose(purpose) {
            addUserMessage(purpose);
            chatState.selectedPurpose = purpose;
    
            setTimeout(() => {
                addAIMessage('ÂàÜ„Åã„Çä„Åæ„Åó„Åü! ÊúÄÈÅ©„Å™„É´„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô... üîç');
                setTimeout(() => {
                    generateAIRoute();
                }, 1500);
            }, 500);
        }

        // „É´„Éº„Éà„ÇíÁîüÊàê
        function generateAIRoute() {
            const { selectedCategories, selectedTime, selectedPurpose } = chatState;
    
            // „É´„Éº„É´Âà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
            let recommendedPlaces = [];
            let routeMessage = '';
    
            // ÊôÇÈñì„Å´Âøú„Åò„ÅüÂ∫óËàóÊï∞„ÇíÊ±∫ÂÆö
            let maxPlaces = 1;
            if (selectedTime === '1„Äú2ÊôÇÈñì') maxPlaces = 2;
            if (selectedTime === '2„Äú3ÊôÇÈñì') maxPlaces = 3;
            if (selectedTime === '3ÊôÇÈñì‰ª•‰∏ä') maxPlaces = 4;
    
            // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´ÊúÄÈÅ©„Å™Â∫óËàó„ÇíÈÅ∏Êäû
            selectedCategories.forEach((category, index) => {
                if (index < maxPlaces) {
                    const place = findBestPlaceForAI(category, selectedPurpose);
                    if (place) {
                        recommendedPlaces.push(place);
                    }
                }
            });
    
            // „É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
            if (recommendedPlaces.length === 0) {
                routeMessage = 'Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁèæÂú®„Åä„Åô„Åô„ÇÅ„Åß„Åç„ÇãÂ∫óËàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü üò¢';
            } else {
                routeMessage = `ÂÆåÁíß„Å™„É´„Éº„Éà„Åå„Åß„Åç„Åæ„Åó„Åü! üéâ\n\n${recommendedPlaces.map((p, i) => 
                    `${i + 1}. ${p.name} (${p.specialty})`
                ).join('\n')}`;
            }
    
            addAIMessage(routeMessage);
    
            if (recommendedPlaces.length > 0) {
                setTimeout(() => {
                    showAIRoutePreview(recommendedPlaces);
                }, 1000);
            }
        }

        // AI„É´„Éº„ÉàÂà§ÂÆöÁî®„ÅÆÂ∫óËàóÊ§úÁ¥¢Ôºà„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÁâàÔºâ
        function findBestPlaceForAI(category, purpose) {
            const places = placesData.filter(p => p.category === category);
    
            // Ê∑∑Èõë„Åó„Å¶„ÅÑ„ÇãÂ∫ó„ÅØÈô§Â§ñ
            const availablePlaces = places.filter(p => p.status !== 'busy');
    
            if (availablePlaces.length === 0) {
                // Á©∫„ÅÑ„Å¶„ÅÑ„ÇãÂ∫ó„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰Ωì„Åã„ÇâÈÅ∏„Å∂
                return places.sort((a, b) => b.rating - a.rating)[0];
            }
    
            // ÁõÆÁöÑÂà•„ÅÆÈáç„Åø‰ªò„ÅëË®≠ÂÆö
            const weights = {
                'Âá∫Âºµ„Éª‰ªï‰∫ãÂ∏∞„Çä': { 
                    distance: 0.7,  // Ë∑ùÈõ¢„ÇíÈáçË¶ñ (Ëøë„ÅÑÂ∫óÂÑ™ÂÖà)
                    rating: 0.3     // Ë©ï‰æ°„ÅØÂèÇËÄÉÁ®ãÂ∫¶
                },
                'Êó•Â∏∞„ÇäË¶≥ÂÖâ': { 
                    distance: 0.3,  // Ë∑ùÈõ¢„ÅØ„ÅÇ„Åæ„ÇäÊ∞ó„Å´„Åó„Å™„ÅÑ
                    rating: 0.7     // Ë©ï‰æ°„ÅÆÈ´ò„ÅÑÂ∫óÂÑ™ÂÖà
                },
                '‰πó„ÇäÁ∂ô„Åé„ÉªÈÄöÈÅé': { 
                    distance: 0.9,  // „Å®„Å´„Åã„ÅèËøë„ÅÑÂ∫ó
                    rating: 0.1     // Ë©ï‰æ°„ÅØ‰∫å„ÅÆÊ¨°
                },
                'Âú∞ÂÖÉ„Åß„ÅÆÊôÇÈñì„Å§„Å∂„Åó': { 
                    distance: 0.5,  // „Éê„É©„É≥„ÇπÂûã
                    rating: 0.5 
                }
            };
    
            // ÈÅ∏Êäû„Åï„Çå„ÅüÁõÆÁöÑ„Å´ÂØæÂøú„Åô„ÇãÈáç„Åø„ÇíÂèñÂæó
            const weight = weights[purpose] || { distance: 0.5, rating: 0.5 };
    
            // „É¶„Éº„Ç∂„Éº„ÅÆÁèæÂú®Âú∞„ÇíÂèñÂæóÔºàÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÂÆáÈÉΩÂÆÆÈßÖ„Çí‰ΩøÁî®Ôºâ
            const userLat = userLocation ? userLocation.lat : 36.5579;
            const userLng = userLocation ? userLocation.lng : 139.8984;
    
            // ÂêÑÂ∫óËàó„Å´„Çπ„Ç≥„Ç¢„Çí‰ªò„Åë„Çã
            const scoredPlaces = availablePlaces.map(place => {
                // Ë∑ùÈõ¢„ÇíË®àÁÆó (km)
                const distance = calculateDistance(userLat, userLng, place.lat, place.lng);
        
                // Ë∑ùÈõ¢„Çπ„Ç≥„Ç¢: Ëøë„ÅÑ„Åª„Å©È´òÂæóÁÇπ (ÊúÄÂ§ß10ÁÇπ)
                // 1km‰ª•ÂÜÖ = 10ÁÇπ„ÄÅ5km‰ª•‰∏ä = 0ÁÇπ
                const distanceScore = Math.max(0, 10 - (distance * 2));
        
                // Ë©ï‰æ°„Çπ„Ç≥„Ç¢: 5ÊÆµÈöéË©ï‰æ°„Çí10ÁÇπÊ∫ÄÁÇπ„Å´Â§âÊèõ
                const ratingScore = (place.rating / 5) * 10;
        
                // Èáç„Åø‰ªò„ÅëÂêàË®à„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
                const totalScore = 
                    (weight.distance * distanceScore) + 
                    (weight.rating * ratingScore);
        
                return {
                    ...place,
                    distance: distance,
                    distanceScore: distanceScore,
                    ratingScore: ratingScore,
                    totalScore: totalScore
                };
            });
    
            // „Çπ„Ç≥„Ç¢„ÅåÈ´ò„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
            scoredPlaces.sort((a, b) => b.totalScore - a.totalScore);
    
            // „Éá„Éê„ÉÉ„Ç∞Áî®: ‰∏ä‰Ωç3Â∫óËàó„ÅÆ„Çπ„Ç≥„Ç¢„ÇíË°®Á§∫
            console.log(`ü§ñ ${category} „ÅÆ„Åä„Åô„Åô„ÇÅÂ∫óËàó (ÁõÆÁöÑ: ${purpose})`);
            scoredPlaces.slice(0, 3).forEach((p, i) => {
                console.log(`${i + 1}. ${p.name}`);
                console.log(`   Ë∑ùÈõ¢: ${p.distance.toFixed(2)}km (${p.distanceScore.toFixed(1)}ÁÇπ)`);
                console.log(`   Ë©ï‰æ°: ${p.rating} (${p.ratingScore.toFixed(1)}ÁÇπ)`);
                console.log(`   Á∑èÂêà: ${p.totalScore.toFixed(1)}ÁÇπ`);
            });
    
            // ÊúÄ„ÇÇ„Çπ„Ç≥„Ç¢„ÅåÈ´ò„ÅÑÂ∫óËàó„ÇíËøî„Åô
            return scoredPlaces[0];
        }

        // „É´„Éº„Éà„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫
        function showAIRoutePreview(places) {
            addAIMessage('„Åì„ÅÆ„É´„Éº„Éà„ÅßÂá∫Áô∫„Åó„Åæ„Åô„Åã?', true, [
                { text: 'üöÄ „Åì„ÅÆ„É´„Éº„Éà„ÅßÂá∫Áô∫!', action: () => startAIRoute(places) },
                { text: 'üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶Áõ∏Ë´á„Åô„Çã', action: () => { closeAIChat(); setTimeout(openAIChat, 300); } },
                { text: '‚ùå „ÇÑ„ÇÅ„Çã', action: () => closeAIChat() }
            ]);
        }

        // AI„É´„Éº„Éà„ÇíÂÆüË°å
        function startAIRoute(places) {
            addUserMessage('„Åì„ÅÆ„É´„Éº„Éà„ÅßÂá∫Áô∫!');
    
            setTimeout(() => {
                addAIMessage('Á¥†Êïµ„Å™ÂÆáÈÉΩÂÆÆË¶≥ÂÖâ„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ! üéâ‚ú®');
        
                setTimeout(() => {
                    // Êó¢Â≠ò„ÅÆ„É´„Éº„ÉàÊ©üËÉΩ„Å®ÈÄ£Êê∫
                    closeAIChat();
            
                    // ÈÅ∏Êäû„Åï„Çå„ÅüÂ∫óËàó„Çí„É´„Éº„Éà„É¢„Éº„Éâ„Å´Ë®≠ÂÆö
                    selectedPlacesForRoute = places;
                    isRouteMode = true;
                    document.getElementById('routePanel').classList.add('active');
                    updateSelectedPlacesDisplay();
            
                    // Âú∞Âõ≥„ÇíÊúÄÂàù„ÅÆÂ∫óËàó„Å´ÁßªÂãï
                    if (places[0]) {
                        map.setView([places[0].lat, places[0].lng], 15);
                    }
            
                    showToast('ü§ñ AI„ÅåÊèêÊ°à„Åó„Åü„É´„Éº„Éà„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü!');
                }, 1500);
            }, 500);
        }
        // ============================================
        // ËÉåÊôØ„ÉÜ„Éº„ÉûÂ§âÊõ¥Ê©üËÉΩÔºà„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Ôºâ
        // ============================================

        const THEME_GRADIENTS = {
            ocean: 'linear-gradient(to left, #ffd89b 0%, #19547b 100%)',
            sunset: 'linear-gradient(to left, #7084a5, #ada6be, #d4b0b5)',
            forest: 'linear-gradient(to left, #2f7f29, #549854, #a5caa7)',
            night: 'linear-gradient(to left, #5c658b, #1c2c52, #051637)'
        };

        // „ÉÜ„Éº„ÉûÂ§âÊõ¥Èñ¢Êï∞
        function changeThemeColor(themeName) {
            const gradient = THEME_GRADIENTS[themeName] || THEME_GRADIENTS.default;
            document.body.style.background = gradient;
            localStorage.setItem('utsunomiya_theme', themeName);
            showToast('üé® „ÉÜ„Éº„Éû„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');
        }

        // „É™„Çª„ÉÉ„ÉàÈñ¢Êï∞
        function resetThemeColor() {
            document.body.style.background = THEME_GRADIENTS.default;
            localStorage.removeItem('utsunomiya_theme');
            showToast('üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åó„Åü');
            }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„ÉÜ„Éº„Éû„ÇíÂæ©ÂÖÉ
        window.addEventListener('load', function() {
            const savedTheme = localStorage.getItem('utsunomiya_theme');
            if (savedTheme && THEME_GRADIENTS[savedTheme]) {
                document.body.style.background = THEME_GRADIENTS[savedTheme];
            }
        });

    </script>
</body>
</html>